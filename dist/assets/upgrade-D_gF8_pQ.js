import{r as u,j as e,B as g,t as M,T as n,x as E,G as R,n as T,K as W,a3 as z,D as U,S as $,a4 as _,g as P,a2 as se,ak as oe,h as I}from"./index-C9f5bxSM.js";const L=120,k=3,b="https://api.bookmyevent.ae";function ae(){var D;const[N,B]=u.useState([]),[F,O]=u.useState(!0),[H,A]=u.useState(null),[V,K]=u.useState(null),[J,G]=u.useState(null),[S,d]=u.useState({open:!1,message:"",severity:"info"}),[h,C]=u.useState(null),[Y,j]=u.useState(!0),x=localStorage.getItem("moduleId"),v=JSON.parse(localStorage.getItem("user")||"{}"),m=v==null?void 0:v._id;u.useEffect(()=>{const s=new URLSearchParams(window.location.search);if(!s.get("orderId")){j(!1);return}(async()=>{var i,r,c,o;try{d({open:!0,message:"Verifying payment...",severity:"info"});const t=await I.post(`${b}/api/razorpay/subscription/verify`,{razorpay_payment_id:s.get("razorpay_payment_id"),razorpay_subscription_id:s.get("razorpay_subscription_id"),razorpay_signature:s.get("razorpay_signature")});if(console.log("âœ… Verify response:",t.data),t.data.success){d({open:!0,message:"ðŸŽ‰ Premium Plan Activated!",severity:"success"});const y=typeof t.data.subscription.moduleId=="object"&&((i=t.data.subscription.moduleId)==null?void 0:i._id)||t.data.subscription.moduleId,f=await I.get(`${b}/api/subscription/status/${m}?moduleId=${y}`);if(console.log("âœ… Subscription response:",f.data),f.data.success&&f.data.subscription){const l=f.data.subscription,w=typeof l.moduleId=="object"&&((r=l.moduleId)==null?void 0:r._id)||l.moduleId;localStorage.setItem("moduleId",w);const Z=new Date(l.endDate),ee=Math.max(0,Math.ceil((Z-new Date)/(1e3*60*60*24)));localStorage.setItem("upgrade",JSON.stringify({isSubscribed:!0,status:"active",plan:l.planId,module:w,access:{canAccess:!0,isExpired:!1,daysLeft:ee}})),console.log("âœ… LocalStorage updated - moduleId:",w),C(l),window.history.replaceState({},"",window.location.pathname),setTimeout(()=>{window.location.replace("/vehicle-setup/leads")},2e3)}}else d({open:!0,message:t.data.message||"Payment verification failed",severity:"error"})}catch(t){console.error("âŒ Payment verification error:",t),d({open:!0,message:((o=(c=t.response)==null?void 0:c.data)==null?void 0:o.message)||"Payment verification failed",severity:"error"})}finally{j(!1)}})()},[m,x]),u.useEffect(()=>{if(new URLSearchParams(window.location.search).get("orderId"))return;const a=localStorage.getItem("moduleId");console.log("ðŸ” ========== SUBSCRIPTION CHECK DEBUG =========="),console.log("ðŸ” userId:",m),console.log("ðŸ” moduleId (component):",x),console.log("ðŸ” moduleId (fresh from localStorage):",a),console.log("ðŸ” upgrade localStorage:",localStorage.getItem("upgrade"));const p=r=>{var c;try{const o=JSON.parse(localStorage.getItem("upgrade")||"{}"),t=typeof(o==null?void 0:o.module)=="object"?(c=o==null?void 0:o.module)==null?void 0:c._id:o==null?void 0:o.module;if(console.log("ðŸ” Fallback check:"),console.log("  - upgrade.status:",o==null?void 0:o.status),console.log("  - upgrade.module (upgradeModuleId):",t),console.log("  - checkModuleId:",r),console.log("  - Match?",(o==null?void 0:o.status)==="active"&&t===r),(o==null?void 0:o.status)==="active"&&t===r)return console.log("âœ… Premium detected via localStorage!"),C({status:"active",isCurrent:!0,planId:o==null?void 0:o.plan,moduleId:t}),!0}catch(o){console.error("localStorage parse error:",o)}return!1};(async()=>{var c;const r=a||x;if(!m||!r){console.log("âš ï¸ Missing userId or moduleId, trying fallback..."),p(r),j(!1);return}try{console.log("ðŸ“¡ Calling API:",`${b}/api/subscription/status/${m}?moduleId=${r}`);const o=await I.get(`${b}/api/subscription/status/${m}?moduleId=${r}`);if(console.log("ðŸ“¡ API Response:",o.data),o.data.success&&o.data.subscription){const t=o.data.subscription;if(console.log("ðŸ“¡ Subscription object:",t),console.log("ðŸ“¡ sub.status:",t.status),console.log("ðŸ“¡ sub.isCurrent:",t.isCurrent),t.status==="active"&&t.isCurrent){console.log("âœ… Premium ACTIVE from API!");const y=typeof t.moduleId=="object"&&((c=t.moduleId)==null?void 0:c._id)||t.moduleId,f=new Date(t.endDate),w=Math.max(0,Math.ceil((f-new Date)/(1e3*60*60*24)));localStorage.setItem("upgrade",JSON.stringify({isSubscribed:!0,status:"active",plan:t.planId,module:y,access:{canAccess:!0,isExpired:!1,daysLeft:w}})),localStorage.setItem("moduleId",y),console.log("âœ… localStorage synced with API data"),C(t),j(!1);return}else console.log("âš ï¸ Subscription exists but not active/current:",t.status,t.isCurrent)}else console.log("âš ï¸ No subscription in API response or success=false"),console.log("âš ï¸ Full response:",JSON.stringify(o.data));console.log("ðŸ”„ Checking localStorage fallback..."),p(r)}catch(o){console.error("âŒ API error:",o.message),p(r)}finally{j(!1)}})()},[m,x]),u.useEffect(()=>{x&&(async()=>{try{const a=await I.get(`${b}/api/subscription/plan/module/${x}`);B(a.data.plans||[])}catch{d({open:!0,message:"Failed to load plans",severity:"error"})}finally{O(!1)}})()},[x]);const X=()=>new Promise(s=>{if(window.Razorpay){s(!0);return}const a=document.createElement("script");a.src="https://checkout.razorpay.com/v1/checkout.js",a.async=!0,a.onload=()=>{console.log("âœ… Razorpay SDK loaded"),s(!0)},a.onerror=()=>{console.error("âŒ Razorpay SDK failed to load"),s(!1)},document.body.appendChild(a)}),q=async s=>{if(!m||!x){d({open:!0,message:"User or module missing",severity:"warning"});return}try{if(A(s._id),!await X())throw new Error("Razorpay SDK failed to load");const p=await I.post(`${b}/api/razorpay/subscription/create`,{providerId:m,planId:s._id,customerEmail:v.email,customerPhone:v.mobile||"9999999999"}),{razorpay:i,customer:r}=p.data;if(console.log("ðŸ”‘ Razorpay Key:",i.key),console.log("ðŸ§ª Razorpay Mode:",i.key.startsWith("rzp_test_")?"TEST MODE":"LIVE MODE"),!(i!=null&&i.subscriptionId))throw new Error("Subscription ID missing from backend");const c={key:i.key,subscription_id:i.subscriptionId,name:"Book My Event",description:`${s.name} Subscription`,image:"/logo.png",handler:async function(t){var y,f;console.log("âœ… Razorpay Response:",t);try{if((await I.post(`${b}/api/razorpay/subscription/verify`,t)).data.success)d({open:!0,message:"ðŸŽ‰ Subscription Activated!",severity:"success"}),setTimeout(()=>{window.location.replace("/vehicle-setup/leads")},1500);else throw new Error("Verification failed")}catch(l){console.error("âŒ Verification error:",l),d({open:!0,message:((f=(y=l.response)==null?void 0:y.data)==null?void 0:f.message)||"Payment verification failed",severity:"error"})}},prefill:{email:r.email,contact:r.phone},theme:{color:"#c62828"}};new window.Razorpay(c).open()}catch(a){console.error("âŒ Razorpay Error:",a),d({open:!0,message:a.message||"Payment failed",severity:"error"}),A(null)}};if(F||Y)return e.jsx(g,{sx:{minHeight:"100vh",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(M,{sx:{color:"#c62828"}})});const Q=s=>{var a;return((a=h==null?void 0:h.planId)==null?void 0:a._id)===s};return e.jsxs(g,{sx:{minHeight:"100vh",bgcolor:"#f9fafc",py:6},children:[e.jsxs(g,{maxWidth:"md",mx:"auto",px:2,children:[e.jsx(n,{variant:"h4",fontWeight:800,textAlign:"center",children:h?"Manage Your Plan":"Upgrade Your Plan"}),e.jsx(n,{textAlign:"center",color:"text.secondary",mb:3,children:"Choose the best plan for your business"}),h?e.jsxs(E,{severity:"success",sx:{mb:4,border:"1px solid #4caf50"},children:["Current Plan: ",e.jsx("b",{children:((D=h.planId)==null?void 0:D.name)||"PREMIUM"})]}):e.jsxs(E,{severity:"info",sx:{mb:4,border:"1px solid #2196f3"},children:["Current Plan: ",e.jsx("b",{children:"FREE"})," - Upgrade to unlock premium features"]}),e.jsxs(R,{container:!0,spacing:3,justifyContent:"center",children:[!h&&e.jsx(R,{item:!0,xs:12,md:6,children:e.jsx(T,{sx:{height:"100%",borderRadius:4,border:"2px solid #e0e0e0",boxShadow:"0 2px 8px rgba(0,0,0,0.1)"},children:e.jsxs(W,{children:[e.jsx(z,{label:"CURRENT PLAN",sx:{bgcolor:"#9e9e9e",color:"#fff",mb:2}}),e.jsx(n,{variant:"h6",fontWeight:800,children:"FREE"}),e.jsx(n,{color:"text.secondary",sx:{minHeight:48},children:"Basic access to get started on the platform"}),e.jsx(n,{variant:"h4",fontWeight:900,color:"#9e9e9e",mt:2,children:"â‚¹0"}),e.jsx(U,{sx:{my:2}}),e.jsx($,{spacing:1,children:["Limited listings","Basic visibility","Standard support"].map(s=>e.jsxs(g,{display:"flex",alignItems:"center",children:[e.jsx(_,{sx:{color:"#9e9e9e",mr:1,fontSize:20}}),e.jsx(n,{variant:"body2",children:s})]},s))}),e.jsx(P,{fullWidth:!0,disabled:!0,sx:{mt:3,bgcolor:"#e0e0e0",color:"#757575",fontWeight:700,borderRadius:2,textTransform:"none"},children:"Current Plan"})]})})}),N.map(s=>{const a=V===s._id,p=J===s._id,i=H===s._id,r=Q(s._id);return e.jsx(R,{item:!0,xs:12,md:6,children:e.jsx(T,{sx:{height:"100%",borderRadius:4,border:r?"3px solid #4caf50":"3px solid #c62828",boxShadow:r?"0 4px 20px rgba(76, 175, 80, 0.2)":"0 4px 20px rgba(198, 40, 40, 0.2)"},children:e.jsxs(W,{children:[e.jsx(z,{icon:r?e.jsx(_,{}):e.jsx(se,{}),label:r?"CURRENT PLAN":"BEST VALUE",sx:{bgcolor:r?"#4caf50":"#c62828",color:"#fff",mb:2,fontWeight:700}}),e.jsx(n,{variant:"h6",fontWeight:800,color:r?"#4caf50":"#c62828",children:s.name}),s.description&&s.description.length>L?e.jsxs(n,{color:"text.secondary",sx:{minHeight:48},children:[a?s.description:`${s.description.slice(0,L)}...`,e.jsx(P,{size:"small",onClick:()=>K(a?null:s._id),sx:{textTransform:"none",fontWeight:600,color:r?"#4caf50":"#c62828",p:0,minWidth:"auto",ml:.5},children:a?"Read less":"Read more"})]}):e.jsx(n,{color:"text.secondary",sx:{minHeight:48},children:s.description}),e.jsxs(g,{sx:{mt:2},children:[e.jsx(z,{label:"ðŸŽ‰ Pre-Launch Offer",sx:{bgcolor:"#fff3cd",color:"#b45309",fontWeight:700,mb:1}}),e.jsxs(g,{sx:{display:"flex",alignItems:"baseline",gap:2},children:[e.jsx(n,{sx:{textDecoration:"line-through",color:"#9ca3af",fontSize:18,fontWeight:600},children:"â‚¹20,000"}),e.jsxs(n,{sx:{fontSize:32,fontWeight:900,color:r?"#4caf50":"#c62828"},children:["â‚¹",s.price]}),e.jsx(n,{sx:{fontSize:14,color:"text.secondary"},children:"/ year"})]}),e.jsx(n,{sx:{fontSize:13,color:"#6b7280",mt:.5},children:"Limited time launch offer for early partners"})]}),e.jsx(U,{sx:{my:2}}),e.jsx($,{spacing:1,children:(p?s.features:s.features.slice(0,k)).map((c,o)=>e.jsxs(g,{display:"flex",alignItems:"flex-start",children:[e.jsx(_,{sx:{color:r?"#4caf50":"#c62828",mr:1,mt:.3,fontSize:20}}),e.jsx(n,{variant:"body2",children:c})]},o))}),s.features.length>k&&e.jsx(P,{size:"small",onClick:()=>G(p?null:s._id),sx:{mt:1,textTransform:"none",fontWeight:600,color:r?"#4caf50":"#c62828",p:0},children:p?"Show less":`+${s.features.length-k} more features`}),e.jsx(P,{fullWidth:!0,disabled:i||r,onClick:()=>q(s),sx:{mt:3,bgcolor:r?"#e0e0e0":"#c62828",color:r?"#757575":"#fff",fontWeight:800,borderRadius:2,py:1.5,textTransform:"none",fontSize:16,"&:hover":{bgcolor:r?"#e0e0e0":"#b71c1c"},"&:disabled":{bgcolor:"#e0e0e0"}},children:r?"Current Plan":i?e.jsxs(g,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(M,{size:20,sx:{color:"#fff"}}),"Redirecting..."]}):h?"Switch Plan":"Upgrade To Premium"})]})})},s._id)})]}),e.jsx(g,{sx:{mt:4,p:2,bgcolor:"#fff3e0",borderRadius:2,border:"1px solid #ffb74d"},children:e.jsxs(n,{variant:"body2",color:"text.secondary",textAlign:"center",children:["ðŸ’¡ ",e.jsx("strong",{children:"Note:"}),` After clicking "Upgrade To Premium", you'll be redirected to a secure payment page. Your subscription will be activated immediately after successful payment.`]})})]}),e.jsx(oe,{open:S.open,autoHideDuration:4e3,onClose:()=>d({...S,open:!1}),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(E,{onClose:()=>d({...S,open:!1}),severity:S.severity,sx:{width:"100%"},children:S.message})})]})}export{ae as default};
