import{u as ve,a as Ce,ad as we,r as d,j as e,B as s,c as k,ae as re,T as o,af as Se,S as W,g as _,al as Ie,ai as ie,a5 as ae,s as b,y as de,b as ke}from"./index-CtjLdGWU.js";import{A as Ee}from"./Autocomplete-C8mTFxCn.js";import{A as Ae}from"./Add-BxlsqhOg.js";import{D as Te}from"./Delete-14O-ouyb.js";import{C as se}from"./Close-Cm6JqKD1.js";import{C as ne}from"./CloudUpload-BaaSarVx.js";const oe=de(s)(({theme:n})=>({border:"2px dashed #e0e0e0",borderRadius:n.shape.borderRadius,padding:n.spacing(3),textAlign:"center",backgroundColor:n.palette.grey[50],cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"150px","&:hover":{borderColor:"#E15B65"},'& input[type="file"]':{display:"none"}})),le=de(s)({position:"relative",display:"inline-block"}),E="https://api.bookmyevent.ae",Be=()=>{try{const n=localStorage.getItem("user");if(!n)return null;const u=JSON.parse(n);return(u==null?void 0:u._id)||null}catch(n){return console.error("getProviderId parse error",n),null}},ce=()=>localStorage.getItem("token")||sessionStorage.getItem("token")||null,O=n=>{if(!n)return"/placeholder.jpg";let u=String(n||"").toLowerCase().replace(/^uploads/i,"/uploads");return u.startsWith("/")||(u="/"+u),`${E}${u}`},Fe=(n=[])=>n.map(u=>({value:u._id,label:u.title||u.name||"Untitled"})),$e=()=>{var ee,te;const n=ve(),u=Ce(),$=we(),[ue,H]=d.useState("form"),[p,U]=d.useState({packageTitle:"",subtitle:"",description:"",startingPrice:""}),[G,v]=d.useState([{id:Date.now(),heading:"",includes:""}]),[A,j]=d.useState(null),[T,z]=d.useState([]),[ge,L]=d.useState({}),[C,B]=d.useState(null),[F,P]=d.useState([]),[J,f]=d.useState(!1),[q,w]=d.useState(""),[V,S]=d.useState("success"),[i,X]=d.useState(null),[K,Q]=d.useState(!0);d.useEffect(()=>{let t=!1;return(async()=>{try{Q(!0);const a=ce(),l=localStorage.getItem("moduleId");l||console.warn("No moduleId in localStorage");const g={Accept:"application/json"};a&&(g.Authorization=`Bearer ${a}`);const I=l?`${E}/api/categories/modules/${l}`:`${E}/api/categories`,c=await fetch(I,{headers:g});if(!c.ok)throw new Error(`Failed to load categories: ${c.status}`);const m=await c.json();if(!t)if(m.success&&Array.isArray(m.data)){const N=Fe(m.data);z(N);const R={};(m.data||[]).forEach(y=>{R[y._id]=y.title||y.name||""}),L(R)}else z([]),L({})}catch(a){console.error("fetchCategories error",a),z([]),L({})}finally{t||Q(!1)}})(),()=>{t=!0}},[]),d.useEffect(()=>{var t;if((t=$.state)!=null&&t.editPackage){const r=$.state.editPackage;X(r),Y(r)}},[$.state]),d.useEffect(()=>{var t,r;if(i&&T.length>0&&!A&&((t=i.categories)==null?void 0:t.length)>0){const a=((r=i.categories[0])==null?void 0:r._id)||i.categories[0],l=T.find(g=>g.value===a);j(l||{value:a,label:ge[a]||"Uncategorized"})}},[T,i]);const Y=t=>{var a,l;U({packageTitle:t.title||"",subtitle:t.subtitle||"",description:t.description||"",startingPrice:((a=t.price)==null?void 0:a.toString())||""}),v((t.includes||[]).map((g,I)=>({id:Date.now()+I,heading:g.title||"",includes:(g.items||[]).join(", ")})));const r=(l=t.categories)==null?void 0:l[0];j(r?{value:r._id||r,label:r.title||r.name||""}:null),B(null),P([])},D=t=>{const{name:r,value:a}=t.target;U(l=>({...l,[r]:a}))},Z=(t,r,a)=>{v(l=>l.map(g=>g.id===t?{...g,[r]:a}:g))},he=()=>v(t=>[...t,{id:Date.now(),heading:"",includes:""}]),pe=t=>v(r=>r.filter(a=>a.id!==t)),me=t=>{var a;const r=(a=t.target.files)==null?void 0:a[0];r&&B(r)},xe=t=>{const r=Array.from(t.target.files||[]);r.length&&P(a=>[...a,...r])},be=t=>P(r=>r.filter((a,l)=>l!==t)),je=()=>B(null),M=(t,r)=>{r!=="clickaway"&&f(!1)},fe=()=>{i&&Y(i),H("form")},ye=async t=>{var y;t.preventDefault();const r=ce();if(!r){w("Authentication required"),S("error"),f(!0);return}const a=Be();if(!a){console.error("Provider ID missing. user:",localStorage.getItem("user")),w("Provider ID missing. Please login as vendor."),S("error"),f(!0);return}const l=localStorage.getItem("moduleId")||((y=i==null?void 0:i.module)==null?void 0:y._id)||(i==null?void 0:i.module)||"",g=G.filter(h=>h.includes&&h.includes.trim()).map(h=>({title:h.heading.trim()||"Section",items:h.includes.split(",").map(x=>x.trim()).filter(Boolean)})),I=parseFloat(p.startingPrice)||0,c=new FormData;c.append("providerId",a),l&&c.append("module",l),c.append("title",p.packageTitle||"Custom Package"),c.append("subtitle",p.subtitle||""),c.append("description",p.description||""),c.append("cateringType","custom"),c.append("includes",JSON.stringify(g)),A?c.append("categories",JSON.stringify([A.value])):c.append("categories",JSON.stringify([])),c.append("price",String(I)),C&&c.append("thumbnail",C),F.forEach(h=>c.append("images",h));const m=!!(i!=null&&i._id),N=m?`${E}/api/catering/${i._id}`:`${E}/api/catering`,R=m?"PUT":"POST";try{const h=await fetch(N,{method:R,body:c,headers:{Authorization:`Bearer ${r}`}}),x=await h.json().catch(()=>({success:!1,message:"Invalid JSON response"}));if(!h.ok){console.error("Save failed",x),w(x.error||x.message||"Failed to save"),S("error"),f(!0);return}U({packageTitle:"",subtitle:"",description:"",startingPrice:""}),v([{id:Date.now(),heading:"",includes:""}]),j(null),B(null),P([]),X(x.data||null),H("preview"),w(x.message||`Catering ${m?"updated":"created"} successfully`),S("success"),f(!0)}catch(h){console.error("submit error",h),w("Error saving catering: "+(h.message||h)),S("error"),f(!0)}};return ue==="preview"&&i?e.jsx(s,{sx:{p:3,backgroundColor:n.palette.grey[100],minHeight:"100vh",width:"100%"},children:e.jsxs(s,{sx:{width:"100%",margin:"auto",backgroundColor:"white",borderRadius:n.shape.borderRadius,boxShadow:n.shadows[1],p:3,overflowX:"hidden"},children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:2,mb:3},children:[e.jsx(k,{onClick:()=>u(-1),color:"primary",children:e.jsx(re,{})}),e.jsx(o,{variant:"h5",children:"Package Preview"})]}),e.jsxs(s,{sx:{position:"relative",mb:3},children:[e.jsx("img",{src:O(i.thumbnail),alt:i.title,style:{width:"100%",height:200,objectFit:"cover",borderRadius:8},onError:t=>{t.target.onerror=null,t.target.src="/placeholder.jpg"}}),e.jsxs(s,{sx:{position:"absolute",bottom:0,left:0,right:0,background:"linear-gradient(transparent, rgba(0,0,0,0.7))",color:"white",p:2},children:[e.jsx(o,{variant:"h6",children:i.title||"Untitled Package"}),e.jsx(o,{variant:"body2",children:i.subtitle||""})]})]}),e.jsx(o,{variant:"body1",sx:{mb:3,textAlign:"justify"},children:i.description||"No description available."}),i.categories&&i.categories.length>0&&e.jsxs(s,{sx:{mb:3},children:[e.jsx(o,{variant:"h6",sx:{mb:1},children:"Category"}),e.jsx(Se,{label:((ee=i.categories[0])==null?void 0:ee.title)||i.categories[0]||"Uncategorized",variant:"outlined",color:"primary"})]}),e.jsx(o,{variant:"h6",sx:{mb:2},children:"Includes"}),(i.includes||[]).map((t,r)=>{var a;return e.jsxs(s,{sx:{mb:2},children:[e.jsx(o,{variant:"subtitle1",sx:{mb:1,fontWeight:"medium"},children:t.title||"Untitled Section"}),e.jsx(W,{component:"ul",spacing:.5,sx:{pl:2,mb:0},children:((a=t.items)==null?void 0:a.map((l,g)=>e.jsx(o,{variant:"body2",component:"li",children:l},g)))||e.jsx(o,{variant:"body2",color:"text.secondary",children:"No items"})})]},r)}),e.jsxs(s,{sx:{textAlign:"center",mb:3},children:[e.jsx(o,{variant:"h6",sx:{mb:.5},children:"Starting Price"}),e.jsxs(o,{variant:"h4",color:"primary",children:["₹",i.price||0," Per Head"]})]}),e.jsxs(s,{sx:{mb:3},children:[e.jsx(o,{variant:"subtitle1",sx:{mb:1},children:"Gallery"}),e.jsx(W,{direction:"row",spacing:2,sx:{flexWrap:"wrap",justifyContent:"center"},children:(i.images||[]).slice(0,6).map((t,r)=>e.jsx(s,{sx:{position:"relative"},children:e.jsx("img",{src:O(t),alt:`Gallery ${r+1}`,style:{width:150,height:150,objectFit:"cover",borderRadius:8},onError:a=>{a.target.onerror=null,a.target.src="/placeholder.jpg"}})},r))})]}),e.jsx(s,{sx:{display:"flex",gap:2,justifyContent:"center"},children:e.jsx(_,{variant:"outlined",startIcon:e.jsx(Ie,{}),onClick:fe,sx:{color:"#E15B65",borderColor:"#E15B65"},children:"Edit Menu"})}),e.jsx(ie,{open:J,autoHideDuration:6e3,onClose:M,anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(ae,{onClose:M,severity:V,sx:{width:"100%"},children:q})})]})}):e.jsx(s,{sx:{p:3,backgroundColor:n.palette.grey[100],minHeight:"100vh",width:"100%"},children:e.jsxs(s,{sx:{width:"100%",margin:"auto",backgroundColor:"white",borderRadius:n.shape.borderRadius,boxShadow:n.shadows[1],p:3,overflowX:"hidden"},children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:2,mb:3},children:[i&&e.jsx(k,{onClick:()=>u(-1),color:"primary",children:e.jsx(re,{})}),e.jsx(o,{variant:"h5",children:i?"Edit Menu":"Add New Menu"})]}),e.jsxs(s,{component:"form",onSubmit:ye,children:[e.jsx(b,{fullWidth:!0,label:"Package Title",name:"packageTitle",value:p.packageTitle,onChange:D,placeholder:"Type package title",sx:{mb:2},variant:"outlined"}),e.jsx(b,{fullWidth:!0,label:"Subtitle",name:"subtitle",value:p.subtitle,onChange:D,placeholder:"Type subtitle",sx:{mb:2},variant:"outlined"}),e.jsx(b,{fullWidth:!0,label:"Description",name:"description",value:p.description,onChange:D,placeholder:"Type description",multiline:!0,rows:3,sx:{mb:2},variant:"outlined"}),e.jsx(Ee,{fullWidth:!0,options:T,getOptionLabel:t=>t.label,isOptionEqualToValue:(t,r)=>t.value===(r==null?void 0:r.value),value:A,onChange:(t,r)=>j(r),renderInput:t=>e.jsx(b,{...t,label:"Category",placeholder:K?"Loading categories...":"Select a category",sx:{mb:2},variant:"outlined",disabled:K})}),e.jsxs(s,{sx:{mb:3},children:[e.jsxs(s,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(o,{variant:"subtitle1",children:"Menu List"}),e.jsx(_,{variant:"contained",size:"small",onClick:he,startIcon:e.jsx(Ae,{}),sx:{backgroundColor:"#E15B65",color:"white"},children:"Add"})]}),G.map(t=>e.jsxs(s,{sx:{border:`1px solid ${n.palette.grey[300]}`,borderRadius:1,p:2,mb:2},children:[e.jsx(b,{fullWidth:!0,label:"Add heading here",value:t.heading,onChange:r=>Z(t.id,"heading",r.target.value),sx:{mb:2},variant:"outlined"}),e.jsxs(s,{sx:{display:"flex",gap:1,alignItems:"flex-end"},children:[e.jsx(b,{fullWidth:!0,label:"Includes",value:t.includes,onChange:r=>Z(t.id,"includes",r.target.value),multiline:!0,rows:3,sx:{flex:1},variant:"outlined",placeholder:"Enter items separated by commas"}),e.jsx(k,{onClick:()=>pe(t.id),color:"error",sx:{alignSelf:"flex-end"},children:e.jsx(Te,{})})]})]},t.id))]}),e.jsxs(s,{sx:{display:"flex",gap:3,mb:3},children:[e.jsxs(s,{sx:{flex:1},children:[e.jsx(o,{variant:"subtitle2",gutterBottom:!0,children:"Thumbnail Image"}),e.jsxs(oe,{onClick:()=>document.getElementById("thumbnail-upload").click(),children:[C?e.jsxs(s,{sx:{textAlign:"center"},children:[e.jsxs(le,{children:[e.jsx("img",{src:URL.createObjectURL(C),alt:"Thumbnail preview",style:{maxWidth:"100%",maxHeight:100,objectFit:"contain",marginBottom:n.spacing(1)}}),e.jsx(k,{onClick:je,size:"small",sx:{position:"absolute",top:-8,right:-8,backgroundColor:"white",color:"error",boxShadow:n.shadows[2]},children:e.jsx(se,{fontSize:"small"})})]}),e.jsx(o,{variant:"body2",color:"text.secondary",children:C.name})]}):i!=null&&i.thumbnail?e.jsxs(s,{sx:{textAlign:"center"},children:[e.jsx("img",{src:O(i.thumbnail),alt:"Current thumbnail",style:{maxWidth:"100%",maxHeight:100,objectFit:"contain",marginBottom:n.spacing(1)},onError:t=>{t.target.onerror=null,t.target.src="/placeholder.jpg"}}),e.jsx(o,{variant:"body2",color:"text.secondary",children:"Current thumbnail. Click to replace."})]}):e.jsxs(s,{children:[e.jsx(ne,{sx:{fontSize:40,color:n.palette.grey[400],mb:1}}),e.jsx(o,{variant:"body2",color:"#E15B65",sx:{mb:.5,fontWeight:"medium"},children:"Click to upload"}),e.jsx(o,{variant:"body2",color:"text.secondary",children:"Or drag and drop"})]}),e.jsx("input",{type:"file",id:"thumbnail-upload",hidden:!0,accept:"image/jpeg,image/png,image/jpg",onChange:me})]})]}),e.jsxs(s,{sx:{flex:1},children:[e.jsx(o,{variant:"subtitle2",gutterBottom:!0,children:"Gallery Images"}),e.jsxs(oe,{onClick:()=>document.getElementById("gallery-upload").click(),children:[F.length>0?e.jsxs(s,{sx:{textAlign:"center"},children:[e.jsx(W,{direction:"row",flexWrap:"wrap",spacing:1,sx:{justifyContent:"center",mb:1},children:F.map((t,r)=>e.jsxs(le,{children:[e.jsx("img",{src:URL.createObjectURL(t),alt:`Gallery preview ${r+1}`,style:{width:100,height:100,objectFit:"cover",borderRadius:4}}),e.jsx(k,{onClick:()=>be(r),size:"small",sx:{position:"absolute",top:-8,right:-8,backgroundColor:"white",color:"error",boxShadow:n.shadows[2]},children:e.jsx(se,{fontSize:"small"})})]},r))}),e.jsxs(o,{variant:"body2",color:"text.secondary",children:[F.length," image(s) selected"]})]}):e.jsxs(s,{children:[e.jsx(ne,{sx:{fontSize:40,color:n.palette.grey[400],mb:1}}),e.jsx(o,{variant:"body2",color:"#E15B65",sx:{mb:.5,fontWeight:"medium"},children:"Click to upload"}),e.jsx(o,{variant:"body2",color:"text.secondary",children:"Or drag and drop"})]}),e.jsx("input",{type:"file",id:"gallery-upload",hidden:!0,accept:"image/jpeg,image/png,image/jpg",multiple:!0,onChange:xe})]}),((te=i==null?void 0:i.images)==null?void 0:te.length)>0&&e.jsxs(s,{sx:{mt:2},children:[e.jsx(o,{variant:"subtitle2",gutterBottom:!0,color:"text.secondary",children:"Existing Images"}),e.jsx(W,{direction:"row",flexWrap:"wrap",spacing:1,children:i.images.map((t,r)=>e.jsx(s,{sx:{position:"relative"},children:e.jsx("img",{src:O(t),alt:`Existing gallery ${r+1}`,style:{width:100,height:100,objectFit:"cover",borderRadius:4},onError:a=>{a.target.onerror=null,a.target.src="/placeholder.jpg"}})},r))})]})]})]}),e.jsx(s,{sx:{mb:3},children:e.jsx(b,{fullWidth:!0,label:"₹ Price (Starting From)",name:"startingPrice",value:p.startingPrice,onChange:D,type:"number",inputProps:{min:0},InputProps:{endAdornment:e.jsx(ke,{position:"end",children:e.jsx(o,{variant:"body2",color:"text.secondary",children:"Per Head"})})},variant:"outlined"})}),e.jsx(_,{type:"submit",variant:"contained",fullWidth:!0,sx:{backgroundColor:"#E15B65",color:"white",py:1.5},children:i?"Update Menu":"Create Menu"})]}),e.jsx(ie,{open:J,autoHideDuration:6e3,onClose:M,anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(ae,{onClose:M,severity:V,sx:{width:"100%"},children:q})})]})})};export{$e as default};
