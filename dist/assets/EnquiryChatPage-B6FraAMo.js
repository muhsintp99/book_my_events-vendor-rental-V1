import{al as A,w as z,r as l,j as t,B as c,t as M,a8 as L,S as _,b as v,am as $,q as B,T as g,ap as O,s as W,h as P}from"./index-4okDMdnD.js";import{S as F}from"./Send-c1-KBsq2.js";import{s as a}from"./socket-BpXQx-Y7.js";const U=()=>{var N,R,E;const C=A(),j=z(),e=(N=C.state)==null?void 0:N.enquiry,[h,b]=l.useState(""),[I,f]=l.useState([]),[k,S]=l.useState(!0),w=l.useRef(null),o=JSON.parse(localStorage.getItem("user"))||{},x=(o==null?void 0:o.providerId)||(o==null?void 0:o._id);l.useEffect(()=>{e!=null&&e._id||j("/venue/enquiries")},[e==null?void 0:e._id,j]),l.useEffect(()=>{if(!(e!=null&&e._id))return;(async()=>{var n;try{S(!0);const s=await P.get(`https://api.bookmyevent.ae/api/enquiries/${e._id}/messages`);f(((n=s.data)==null?void 0:n.data)||[])}catch(s){console.error("Failed to fetch messages:",s),f([])}finally{S(!1)}})()},[e==null?void 0:e._id]);const p=l.useRef(new Set);l.useEffect(()=>{if(!(e!=null&&e._id)||!x)return;a.connected||a.connect(),a.emit("join_enquiry",{enquiryId:e._id,vendorId:x});const i=s=>{console.log("ðŸ“¨ Received message:",s);const d=s._id||`${s.senderId}-${s.timestamp}`;if(p.current.has(d)||p.current.has(s.timestamp)){p.current.delete(d),p.current.delete(s.timestamp),f(r=>r.map(m=>m.timestamp===s.timestamp&&m.senderId===s.senderId?{...s,time:s.time||new Date(s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}:m));return}f(r=>r.some(u=>u._id===s._id||u.timestamp&&u.timestamp===s.timestamp&&u.senderId===s.senderId)?r:[...r,{...s,time:s.time||new Date(s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}])},n=s=>{console.log("ðŸ—‘ï¸ Message deleted:",s.messageId),f(d=>d.filter(r=>r._id!==s.messageId))};return a.on("receive_message",i),a.on("message_deleted",n),()=>{a.off("receive_message",i),a.off("message_deleted",n)}},[e==null?void 0:e._id,x]),l.useEffect(()=>{var i;(i=w.current)==null||i.scrollIntoView({behavior:"smooth"})},[I]);const y=()=>{var r;if(!h.trim()||!(e!=null&&e._id))return;const i=h;b("");const n=new Date().toISOString(),s={enquiryId:e._id,senderId:x,receiverId:((r=e.userId)==null?void 0:r._id)||e.userId,senderName:(o==null?void 0:o.businessName)||(o==null?void 0:o.name)||"Vendor",senderRole:"vendor",text:i,message:i,timestamp:n},d="optimistic-"+Date.now();p.current.add(n),f(m=>[...m,{...s,_id:d,time:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}]),a.emit("send_message",s)},T=i=>{!a.connected||!(e!=null&&e._id)||window.confirm("Unsend this message?")&&a.emit("delete_message",{messageId:i,enquiryId:e._id})};if(!(e!=null&&e._id))return t.jsx(c,{p:4,children:t.jsx(M,{})});const D=(R=e.userId)!=null&&R.firstName?`${e.userId.firstName} ${e.userId.lastName||""}`.trim():e.fullName||"Customer";return t.jsx(c,{sx:{width:"100%",height:"100vh",display:"flex",flexDirection:"column"},children:t.jsxs(L,{elevation:0,sx:{width:"100%",height:"100%",display:"flex",flexDirection:"column",borderRadius:0,overflow:"hidden"},children:[t.jsx(c,{sx:{p:2,bgcolor:"#1abc9c",color:"#fff"},children:t.jsxs(_,{direction:"row",alignItems:"center",spacing:2,children:[t.jsx(v,{onClick:()=>j(-1),sx:{color:"#fff"},children:t.jsx($,{})}),t.jsx(B,{sx:{bgcolor:"rgba(255,255,255,0.2)"},children:D.charAt(0)}),t.jsxs(c,{children:[t.jsx(g,{variant:"h6",fontWeight:600,children:D}),t.jsx(g,{variant:"caption",sx:{opacity:.8},children:((E=e.moduleId)==null?void 0:E.title)||"Enquiry"})]})]})}),t.jsxs(c,{sx:{flex:1,overflowY:"auto",p:3,bgcolor:"#fff",display:"flex",flexDirection:"column",gap:2},children:[k?t.jsx(c,{display:"flex",justifyContent:"center",py:4,children:t.jsx(M,{})}):I.length===0?t.jsx(c,{textAlign:"center",py:4,color:"text.secondary",children:"No messages yet."}):I.map((i,n)=>{const s=i.senderId===x,d=String(i._id).startsWith("optimistic-");return t.jsx(c,{sx:{alignSelf:s?"flex-end":"flex-start",maxWidth:"70%"},children:t.jsxs(c,{sx:{p:1.5,borderRadius:s?"12px 12px 0 12px":"12px 11px 12px 0",bgcolor:s?"#1abc9c":"#bbc6cc",color:s?"#fff":"#000",position:"relative","&:hover .delete-msg":{opacity:1}},children:[t.jsx(g,{variant:"body2",children:i.text||i.message}),s&&!d&&t.jsx(v,{className:"delete-msg",size:"small",onClick:()=>T(i._id),sx:{position:"absolute",top:-10,right:-10,bgcolor:"#ff4d4d",color:"#fff",p:.2,opacity:0,transition:"opacity 0.2s","&:hover":{bgcolor:"#cc0000"}},children:t.jsx(O,{sx:{fontSize:14}})}),t.jsxs(_,{direction:"row",justifyContent:"flex-end",sx:{mt:.5},children:[d&&t.jsx(g,{variant:"caption",sx:{fontSize:"10px",fontStyle:"italic",opacity:.7},children:"sending..."}),t.jsx(g,{variant:"caption",sx:{fontSize:"10px",opacity:.7},children:i.time})]})]})},i._id||n)}),t.jsx("div",{ref:w})]}),t.jsx(c,{sx:{p:2,borderTop:"1px solid #eee",bgcolor:"#fff"},children:t.jsxs(_,{direction:"row",spacing:1,children:[t.jsx(W,{fullWidth:!0,size:"small",placeholder:"Type a message...",value:h,onChange:i=>b(i.target.value),onKeyDown:i=>i.key==="Enter"&&y(),sx:{"& .MuiOutlinedInput-root":{borderRadius:"20px"}}}),t.jsx(v,{onClick:y,disabled:!h.trim(),sx:{bgcolor:"#1abc9c",color:"#fff","&:hover":{bgcolor:"#16a085"}},children:t.jsx(F,{})})]})})]})})};export{U as default};
