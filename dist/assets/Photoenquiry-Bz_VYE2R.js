import{r as o,j as e,a9 as $,aa as Q,S as H,q as oe,B as g,T as r,b as y,ab as X,t as Z,ap as ee,ad as se,s as te,w as ae,x as ie,a8 as le,ac as re,W as A,aj as V,V as ce,G as F,p as G,M as J,P as de,ag as xe,av as he,g as U,ar as ue,h as fe}from"./index-CxFmThG8.js";import{C as Y}from"./Chat-B37pLeGZ.js";import{C as ne}from"./Close-BuO2MOoh.js";import{E as me}from"./Event-BOAm-gH6.js";import{C as je}from"./Category-BrY0Mpzm.js";import{A as ge}from"./AccessTime-CL4dsrjI.js";import{C as pe}from"./ChatBubbleOutline-BUX542E3.js";import{D as Ce}from"./DoneAll-ByHByPwU.js";import{S as Se}from"./Send-B5VTgPhl.js";import{s as i}from"./socket-BpXQx-Y7.js";import{T as be}from"./TableContainer-MWnyzJ5Y.js";import{T as ve,a as O,b as l,c as ye}from"./TableRow-BobOFfSn.js";import{T as Ie}from"./TableHead-DUu2iJwC.js";const De=({open:I,onClose:C,enquiry:a})=>{var T,L;const[f,N]=o.useState(""),[w,S]=o.useState([]),[k,R]=o.useState(!1),[b,z]=o.useState(!1),D=o.useRef(null),p=JSON.parse(localStorage.getItem("user"))||{},M=p==null?void 0:p._id;o.useEffect(()=>{var t;(t=D.current)==null||t.scrollIntoView({behavior:"smooth"})},[w]),o.useEffect(()=>{var s;if(!I||!(a!=null&&a._id))return;R(!0);const t=a._id,h=p==null?void 0:p._id,m=((s=a.userId)==null?void 0:s._id)||a.userId;i.connected||i.connect();const c=()=>{z(!0),i.emit("join_enquiry",{enquiryId:t,vendorId:h,userId:m})},E=()=>{z(!1)},v=n=>{S(n||[]),R(!1)},j=n=>{S(d=>{const _=d.find(u=>{var K;return((K=u._id)==null?void 0:K.startsWith("temp-"))&&(u.message===n.message||u.text===n.message)&&String(u.senderId)===String(n.senderId)});return _?d.map(u=>u._id===_._id?n:u):[...d,n]})},W=({messageId:n})=>{S(d=>d.filter(_=>_._id!==n))};return i.on("connect",c),i.on("disconnect",E),i.on("message_history",v),i.on("receive_message",j),i.on("message_deleted",W),i.connected&&c(),()=>{i.off("connect",c),i.off("disconnect",E),i.off("message_history",v),i.off("receive_message",j),i.off("message_deleted",W)}},[I,a==null?void 0:a._id]);const P=()=>{var c;if(!f.trim())return;const t="temp-"+Date.now(),h=f,m={enquiryId:a._id,senderId:M,receiverId:((c=a.userId)==null?void 0:c._id)||a.userId,senderRole:"vendor",message:h,timestamp:new Date().toISOString()};S(E=>[...E,{...m,_id:t}]),N(""),i.connected&&i.emit("send_message",m)},q=t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),P())},B=t=>{i.connected&&i.emit("delete_message",{messageId:t,enquiryId:a._id})},x=t=>String(t)===String(M);return a?e.jsxs($,{open:I,onClose:C,fullWidth:!0,maxWidth:"sm",PaperProps:{sx:{height:"80vh",display:"flex",flexDirection:"column"}},children:[e.jsx(Q,{sx:{bgcolor:"#075E54",color:"#fff"},children:e.jsxs(H,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(oe,{sx:{bgcolor:"#25D366"},children:((T=a.fullName)==null?void 0:T.charAt(0))||"C"}),e.jsxs(g,{flex:1,children:[e.jsx(r,{fontWeight:600,children:a.fullName}),e.jsxs(r,{variant:"caption",children:[(L=a.moduleId)==null?void 0:L.title,b&&" â€¢ Connected"]})]}),e.jsx(y,{onClick:C,sx:{color:"#fff"},children:e.jsx(ne,{})})]})}),e.jsxs(X,{sx:{flex:1,overflowY:"auto",bgcolor:"#ECE5DD",p:2},children:[k?e.jsx(g,{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",children:e.jsx(Z,{})}):w.length===0?e.jsx(r,{textAlign:"center",color:"text.secondary",children:"No messages yet. Start the conversation!"}):w.map(t=>{var c;const h=x(t.senderId),m=(c=t._id)==null?void 0:c.startsWith("temp-");return e.jsx(g,{display:"flex",justifyContent:h?"flex-end":"flex-start",mb:1,children:e.jsxs(g,{sx:{p:1.5,borderRadius:h?"15px 15px 2px 15px":"15px 15px 15px 2px",bgcolor:h?"#DCF8C6":"#fff",position:"relative",maxWidth:"75%",transition:"0.2s ease","&:hover .delete-btn":{opacity:1,transform:"scale(1)"}},children:[e.jsx(r,{variant:"body2",children:t.message||t.text}),h&&!m&&e.jsx(y,{className:"delete-btn",size:"small",onClick:()=>B(t._id),sx:{position:"absolute",top:-8,right:-8,bgcolor:"#ff4d4d",color:"#fff",p:.5,opacity:0,transform:"scale(0.8)",transition:"all 0.2s ease","&:hover":{bgcolor:"#cc0000"}},children:e.jsx(ee,{sx:{fontSize:12}})}),e.jsxs(r,{variant:"caption",sx:{display:"flex",alignItems:"center",justifyContent:"flex-end",gap:.5,mt:.5,fontSize:"0.65rem",color:"text.secondary"},children:[m?"sending...":e.jsx(Ce,{sx:{fontSize:12,color:"#4caf50"}}),new Date(t.timestamp||t.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})},t._id)}),e.jsx("div",{ref:D})]}),e.jsxs(se,{sx:{p:1.5,bgcolor:"#f7f7f7"},children:[e.jsx(pe,{sx:{color:"#888"}}),e.jsx(te,{fullWidth:!0,size:"small",placeholder:"Type a message...",value:f,onChange:t=>N(t.target.value),onKeyDown:q,multiline:!0,maxRows:3,disabled:!b,sx:{bgcolor:"#fff",borderRadius:"20px","& .MuiOutlinedInput-root":{borderRadius:"20px"}}}),e.jsx(y,{onClick:P,disabled:!f.trim()||!b,sx:{bgcolor:f.trim()&&b?"#25D366":"#ccc",color:"#fff","&:hover":{bgcolor:"#1ebd5a"}},children:e.jsx(Se,{})})]})]}):null},Le=()=>{var W;const I=ae(),[C,a]=o.useState(""),[f,N]=o.useState("all"),[w,S]=o.useState([]),[k,R]=o.useState(!0),[b,z]=o.useState(null),[D,p]=o.useState(null),[M,P]=o.useState(""),[q,B]=o.useState(!1),[x,T]=o.useState(null),[L,t]=o.useState(!1),[h,m]=o.useState(null);o.useEffect(()=>{const s=localStorage.getItem("user");if(s){const n=JSON.parse(s);console.log("Vendor Mongo ID:",n._id),p(n._id)}},[]),o.useEffect(()=>{(async()=>{if(D)try{const n=await fe.get(`https://api.bookmyevent.ae/api/enquiries/provider/${D}`);S(n.data.data||[]),z(null)}catch{z("Failed to fetch enquiries"),S([])}finally{R(!1)}})()},[D]);const c=w.filter(s=>{var u;if(!(((u=s.moduleId)==null?void 0:u.title)==="Photography"))return!1;const d=(s.fullName||"").toLowerCase().includes(C.toLowerCase())||(s.email||"").toLowerCase().includes(C.toLowerCase())||(s.contact||"").includes(C),_=f==="all"||s.status===f;return d&&_}),E=s=>{T(s),B(!0)},v=()=>{B(!1),T(null)},j=({icon:s,label:n,value:d})=>e.jsxs(g,{display:"flex",alignItems:"center",gap:2,py:1.5,sx:{borderBottom:"1px solid",borderColor:"divider","&:last-child":{borderBottom:"none"}},children:[e.jsx(g,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:40,height:40,borderRadius:"50%",bgcolor:"primary.light",color:"primary.main",flexShrink:0},children:s}),e.jsxs(g,{flex:1,children:[e.jsx(r,{variant:"caption",color:"text.secondary",display:"block",children:n}),e.jsx(r,{variant:"body1",fontWeight:500,children:d||"N/A"})]})]});return e.jsxs(g,{p:2,children:[e.jsx(r,{variant:"h4",gutterBottom:!0,children:"Enquiries"}),b&&e.jsx(ie,{severity:"error",sx:{mb:2},children:b}),e.jsxs(le,{sx:{mt:2},children:[e.jsxs(H,{direction:{xs:"column",sm:"row"},spacing:2,p:2,children:[e.jsx(te,{label:"Search enquiries",size:"small",value:C,onChange:s=>a(s.target.value),fullWidth:!0}),e.jsxs(re,{size:"small",value:f,onChange:s=>N(s.target.value),sx:{minWidth:160},children:[e.jsx(A,{value:"all",children:"All"}),e.jsx(A,{value:"pending",children:"Pending"}),e.jsx(A,{value:"responded",children:"Responded"}),e.jsx(A,{value:"confirmed",children:"Confirmed"}),e.jsx(A,{value:"cancelled",children:"Cancelled"})]})]}),e.jsx(be,{children:e.jsxs(ve,{children:[e.jsx(Ie,{children:e.jsxs(O,{children:[e.jsx(l,{children:"#"}),e.jsx(l,{children:"Customer"}),e.jsx(l,{children:"Module"}),e.jsx(l,{children:"Contact"}),e.jsx(l,{children:"Date"}),e.jsx(l,{align:"center",children:"Actions"})]})}),e.jsxs(ye,{children:[k&&e.jsx(O,{children:e.jsx(l,{colSpan:6,align:"center",children:e.jsx(Z,{size:28})})}),!k&&c.map((s,n)=>{var d;return e.jsxs(O,{hover:!0,children:[e.jsx(l,{children:n+1}),e.jsxs(l,{children:[e.jsx(r,{fontWeight:600,children:s.fullName}),e.jsx(r,{variant:"caption",color:"text.secondary",children:s.email})]}),e.jsx(l,{children:(d=s.moduleId)==null?void 0:d.title}),e.jsx(l,{children:s.contact}),e.jsx(l,{children:new Date(s.bookingDate).toLocaleDateString()}),e.jsx(l,{align:"center",children:e.jsxs(H,{direction:"row",spacing:1,justifyContent:"center",children:[e.jsx(V,{title:"Open Chat",children:e.jsx(y,{size:"small",color:"primary",onClick:()=>I("/photography/enquirychat",{state:s}),children:e.jsx(Y,{fontSize:"small"})})}),e.jsx(V,{title:"View Enquiry",children:e.jsx(y,{size:"small",color:"info",onClick:()=>E(s),children:e.jsx(ce,{fontSize:"small"})})}),e.jsx(V,{title:"Delete Enquiry",children:e.jsx(y,{size:"small",color:"error",children:e.jsx(ee,{fontSize:"small"})})})]})})]},s._id)}),!k&&c.length===0&&e.jsx(O,{children:e.jsx(l,{colSpan:6,align:"center",children:"No enquiries found"})})]})]})})]}),e.jsxs($,{open:q,onClose:v,maxWidth:"md",fullWidth:!0,children:[e.jsx(Q,{sx:{bgcolor:"primary.main",color:"white"},children:e.jsxs(g,{display:"flex",justifyContent:"space-between",children:[e.jsx(r,{fontWeight:600,children:"Enquiry Details"}),e.jsx(y,{onClick:v,sx:{color:"white"},children:e.jsx(ne,{})})]})}),e.jsx(X,{children:x&&e.jsxs(F,{container:!0,spacing:3,mt:1,children:[e.jsx(F,{item:!0,xs:12,md:6,children:e.jsx(G,{variant:"outlined",children:e.jsxs(J,{children:[e.jsx(r,{fontWeight:600,mb:2,children:"Customer Information"}),e.jsx(j,{icon:e.jsx(de,{fontSize:"small"}),label:"Full Name",value:x.fullName}),e.jsx(j,{icon:e.jsx(xe,{fontSize:"small"}),label:"Email",value:x.email}),e.jsx(j,{icon:e.jsx(he,{fontSize:"small"}),label:"Contact",value:x.contact})]})})}),e.jsx(F,{item:!0,xs:12,md:6,children:e.jsx(G,{variant:"outlined",children:e.jsxs(J,{children:[e.jsx(r,{fontWeight:600,mb:2,children:"Booking Information"}),e.jsx(j,{icon:e.jsx(je,{fontSize:"small"}),label:"Module",value:(W=x.moduleId)==null?void 0:W.title}),e.jsx(j,{icon:e.jsx(me,{fontSize:"small"}),label:"Booking Date",value:new Date(x.bookingDate).toLocaleDateString()}),e.jsx(j,{icon:e.jsx(ge,{fontSize:"small"}),label:"Created At",value:new Date(x.createdAt).toLocaleString()})]})})})]})}),e.jsxs(se,{children:[e.jsx(U,{onClick:v,variant:"outlined",children:"Close"}),e.jsx(U,{variant:"contained",startIcon:e.jsx(Y,{}),onClick:()=>{v(),I("/photography/enquirychat",{state:x})},children:"Open Chat"})]})]}),e.jsx(De,{open:L,onClose:()=>{t(!1),m(null)},enquiry:h}),e.jsx(ue,{open:!!M,autoHideDuration:3e3,onClose:()=>P(""),message:M})]})};export{Le as default};
