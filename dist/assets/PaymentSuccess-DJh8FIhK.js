import{t as L,r as g,j as o,B as R,s as M,v as O,T as f,g as $}from"./index-2qmD94Bw.js";const k="https://api.bookmyevent.ae";function B(){const[E]=L(),s=E.get("orderId"),l=JSON.parse(localStorage.getItem("user")||"{}"),d=l==null?void 0:l._id,u=localStorage.getItem("moduleId"),[i,c]=g.useState("verifying"),[m,r]=g.useState("Verifying payment...");g.useEffect(()=>{if(!s||!d||!u){c("error"),r("Missing required information. Please contact support.");return}let e,n=0;const p=20;return(async()=>{var x,h,I,S,P,A,b,w,j;try{console.log("ðŸ” Starting payment verification for:",s);const t=await $.post(`${k}/api/payment/verify-subscription-payment`,{orderId:s});if(console.log("âœ… Verify response:",t.data),t.data.success&&((x=t.data.subscription)==null?void 0:x.status)==="active"&&((h=t.data.subscription)!=null&&h.isCurrent)){console.log("âœ… Payment verified and subscription active!"),y(t.data.subscription);return}console.log("â³ Payment pending, starting polling..."),r("Payment confirmed. Activating subscription..."),e=setInterval(async()=>{var D;if(n++,n>p){clearInterval(e),c("error"),r("Activation is taking longer than expected. Your payment is successful. Please refresh the page in a few minutes or contact support.");return}try{console.log(`ðŸ”„ Poll attempt ${n}/${p}`);const a=(D=(await $.get(`${k}/api/subscription/status/${d}?moduleId=${u}`)).data)==null?void 0:D.subscription;(a==null?void 0:a.status)==="active"&&(a!=null&&a.isCurrent)&&(clearInterval(e),console.log("âœ… Subscription activated via polling!"),y(a))}catch(C){console.error("Polling error:",C)}},3e3)}catch(t){console.error("âŒ Payment verification failed:",t),((S=(I=t.response)==null?void 0:I.data)==null?void 0:S.status)==="pending"||(b=(A=(P=t.response)==null?void 0:P.data)==null?void 0:A.message)!=null&&b.includes("pending")?r("Payment is being processed. Checking status..."):(c("error"),r(((j=(w=t.response)==null?void 0:w.data)==null?void 0:j.message)||"Payment verification failed. Please contact support with order ID: "+s))}})(),()=>{e&&clearInterval(e)}},[s,d,u]);const y=e=>{console.log("ðŸ’¾ Updating localStorage...");const n=new Date(e.endDate),v=Math.max(0,Math.ceil((n-new Date)/(1e3*60*60*24)));localStorage.setItem("upgrade",JSON.stringify({isSubscribed:!0,status:"active",plan:e.planId,module:e.moduleId,access:{canAccess:!0,isExpired:!1,daysLeft:v}})),localStorage.setItem("moduleId",e.moduleId),console.log("âœ… LocalStorage updated successfully"),c("success"),r("ðŸŽ‰ Subscription activated successfully! Redirecting..."),window.history.replaceState({},"","/payment-success"),setTimeout(()=>{window.location.href="/makeupartist/portfolio"},2e3)};return o.jsxs(R,{sx:{minHeight:"100vh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",gap:3,p:3,bgcolor:"#f9fafc"},children:[i==="verifying"&&o.jsx(M,{size:60,sx:{color:"#c62828"}}),i==="success"&&o.jsx(R,{sx:{fontSize:80},children:"âœ…"}),i==="error"&&o.jsx(O,{severity:"error",sx:{maxWidth:600},children:m}),o.jsx(f,{variant:"h5",fontWeight:600,textAlign:"center",children:m}),i==="verifying"&&o.jsx(f,{variant:"body2",color:"text.secondary",textAlign:"center",children:"Please do not close this page. This usually takes 5-10 seconds..."}),s&&o.jsxs(f,{variant:"caption",color:"text.secondary",sx:{mt:2,opacity:.6},children:["Order ID: ",s]})]})}export{B as default};
