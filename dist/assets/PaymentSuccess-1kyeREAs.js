import{t as M,r as I,j as n,B as E,s as N,v as O,T as v,g as $}from"./index-BJXhio1F.js";const S="https://api.bookmyevent.ae";function U(){const[k]=M(),t=k.get("orderId"),f=JSON.parse(localStorage.getItem("user")||"{}"),g=f==null?void 0:f._id,u=localStorage.getItem("moduleId"),[p,l]=I.useState("verifying"),[h,s]=I.useState("Verifying payment...");I.useEffect(()=>{if(console.log("ðŸš€ PaymentSuccess component mounted"),console.log("ðŸ“‹ URL params - orderId:",t),console.log("ðŸ“‹ localStorage - userId:",g),console.log("ðŸ“‹ localStorage - moduleId:",u),console.log("ðŸ“‹ Full URL:",window.location.href),!t){console.error("âŒ No orderId in URL!"),l("error"),s("No order ID found. Please check the URL.");return}if(!g||!u){console.error("âŒ Missing userId or moduleId in localStorage!"),l("error"),s("Missing user information. Please login again.");return}let o,i=0;const y=20;return(async()=>{var r,c,d,A,b,w,j,R,D,L;try{console.log("ðŸ” Starting payment verification..."),console.log("ðŸ”— Calling:",`${S}/api/payment/verify-subscription-payment`),console.log("ðŸ“¦ Payload:",{orderId:t});const e=await $.post(`${S}/api/payment/verify-subscription-payment`,{orderId:t});if(console.log("âœ… Verify API Response:",JSON.stringify(e.data,null,2)),e.data.success&&((r=e.data.subscription)==null?void 0:r.status)==="active"&&((c=e.data.subscription)!=null&&c.isCurrent)){console.log("âœ… Payment verified and subscription ACTIVE!"),x(e.data.subscription);return}e.data.success&&e.data.subscription&&console.log("âš ï¸ Subscription exists but status:",e.data.subscription.status),console.log("â³ Payment pending, starting polling..."),s("Payment confirmed. Activating subscription..."),o=setInterval(async()=>{var C;if(i++,i>y){clearInterval(o),l("error"),s("Activation is taking longer than expected. Your payment is successful. Please refresh the page in a few minutes or contact support.");return}try{console.log(`ðŸ”„ Poll attempt ${i}/${y}`);const m=await $.get(`${S}/api/subscription/status/${g}?moduleId=${u}`);console.log("ðŸ“¡ Poll response:",m.data);const a=(C=m.data)==null?void 0:C.subscription;(a==null?void 0:a.status)==="active"&&(a!=null&&a.isCurrent)&&(clearInterval(o),console.log("âœ… Subscription activated via polling!"),x(a))}catch(m){console.error("Polling error:",m.message)}},3e3)}catch(e){console.error("âŒ Payment verification FAILED!"),console.error("âŒ Error:",e.message),console.error("âŒ Response:",(d=e.response)==null?void 0:d.data),((b=(A=e.response)==null?void 0:A.data)==null?void 0:b.status)==="pending"||(R=(j=(w=e.response)==null?void 0:w.data)==null?void 0:j.message)!=null&&R.includes("pending")?(console.log("â³ Payment is pending, will poll..."),s("Payment is being processed. Checking status...")):(l("error"),s(((L=(D=e.response)==null?void 0:D.data)==null?void 0:L.message)||"Payment verification failed. Please contact support with order ID: "+t))}})(),()=>{o&&clearInterval(o)}},[t,g,u]);const x=o=>{var d;console.log("ðŸ’¾ Updating localStorage..."),console.log("ðŸ“¦ Subscription data:",o);const i=new Date(o.endDate),P=Math.max(0,Math.ceil((i-new Date)/(1e3*60*60*24))),r=typeof o.moduleId=="object"&&((d=o.moduleId)==null?void 0:d._id)||o.moduleId,c=o.planId;console.log("ðŸ“ Storing moduleId:",r),console.log("ðŸ“ Storing plan:",c),localStorage.setItem("upgrade",JSON.stringify({isSubscribed:!0,status:"active",plan:c,module:r,access:{canAccess:!0,isExpired:!1,daysLeft:P}})),localStorage.setItem("moduleId",r),console.log("âœ… LocalStorage updated successfully"),console.log("ðŸ” Verification - upgrade:",localStorage.getItem("upgrade")),console.log("ðŸ” Verification - moduleId:",localStorage.getItem("moduleId")),l("success"),s("ðŸŽ‰ Subscription activated successfully! Redirecting..."),window.history.replaceState({},"","/payment-success"),setTimeout(()=>{window.location.replace("/makeupartist/portfolio")},2e3)};return n.jsxs(E,{sx:{minHeight:"100vh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",gap:3,p:3,bgcolor:"#f9fafc"},children:[p==="verifying"&&n.jsx(N,{size:60,sx:{color:"#c62828"}}),p==="success"&&n.jsx(E,{sx:{fontSize:80},children:"âœ…"}),p==="error"&&n.jsx(O,{severity:"error",sx:{maxWidth:600},children:h}),n.jsx(v,{variant:"h5",fontWeight:600,textAlign:"center",children:h}),p==="verifying"&&n.jsx(v,{variant:"body2",color:"text.secondary",textAlign:"center",children:"Please do not close this page. This usually takes 5-10 seconds..."}),t&&n.jsxs(v,{variant:"caption",color:"text.secondary",sx:{mt:2,opacity:.6},children:["Order ID: ",t]})]})}export{U as default};
