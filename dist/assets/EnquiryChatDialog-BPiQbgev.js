import{r,j as e,a9 as _,aa as k,S as E,q as T,B as c,T as d,b as C,ab as N,t as R,ad as z,s as A}from"./index-CLRvsGTH.js";import{S as B}from"./Send-CBVPU9Rv.js";import{C as M}from"./Close-CVhvqm57.js";import{C as W}from"./ChatBubbleOutline-CNT1vnsY.js";import{s as t}from"./socket-BpXQx-Y7.js";const F=({open:l,onClose:p,enquiry:o})=>{var v,S;if(!l||!o)return null;const[i,u]=r.useState(""),[x,m]=r.useState([]),[I,g]=r.useState(!1),[D,h]=r.useState(!1),b=r.useRef(null),n=JSON.parse(localStorage.getItem("user"))||{},y=(n==null?void 0:n.providerId)||(n==null?void 0:n._id);r.useEffect(()=>{var s;(s=b.current)==null||s.scrollIntoView({behavior:"smooth"})},[x]),r.useEffect(()=>{if(!l||!(o!=null&&o._id))return;g(!0),m([]),t.connected||t.connect(),h(t.connected),t.emit("join_enquiry",{enquiryId:o._id,vendorId:y,vendorName:n.businessName||n.name||"Vendor"}),t.on("message_history",a=>{m(a||[]),g(!1)}),t.on("receive_message",a=>{m(f=>[...f,a])}),t.on("connect",()=>{h(!0)}),t.on("disconnect",()=>{h(!1)});const s=setTimeout(()=>{g(!1)},1e3);return()=>{clearTimeout(s),t.off("message_history"),t.off("receive_message"),t.off("connect"),t.off("disconnect")}},[l,o==null?void 0:o._id]);const j=()=>{if(!i.trim())return;const s={enquiryId:o._id,senderId:n._id,senderName:n.businessName||n.name||"Vendor",senderRole:"vendor",text:i,timestamp:new Date().toISOString(),time:new Date().toLocaleTimeString()};t.emit("send_message",s,a=>{console.log("Message sent:",a)}),u("")},w=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),j())};return e.jsxs(_,{open:l,onClose:p,fullWidth:!0,maxWidth:"sm",PaperProps:{sx:{height:"80vh",display:"flex",flexDirection:"column"}},children:[e.jsx(k,{sx:{bgcolor:"#075E54",color:"#fff",p:2,flexShrink:0},children:e.jsxs(E,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(T,{sx:{bgcolor:"#25D366",width:40,height:40},children:((v=o.fullName)==null?void 0:v.charAt(0))||"C"}),e.jsxs(c,{flex:1,children:[e.jsx(d,{fontWeight:600,variant:"subtitle2",children:o.fullName||"Customer"}),e.jsxs(d,{variant:"caption",sx:{opacity:.8},children:[((S=o.moduleId)==null?void 0:S.title)||"Venue"," Enquiry",D&&" â€¢ Connected"]})]}),e.jsx(C,{onClick:p,sx:{color:"#fff","&:hover":{bgcolor:"rgba(255,255,255,0.2)"}},size:"small",children:e.jsx(M,{})})]})}),e.jsxs(N,{sx:{flex:1,overflowY:"auto",bgcolor:"#ECE5DD",p:2,display:"flex",flexDirection:"column"},children:[I?e.jsx(c,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:e.jsx(R,{size:40})}):x.length===0?e.jsx(c,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:e.jsx(d,{color:"text.secondary",textAlign:"center",children:"No messages yet. Start the conversation!"})}):x.map((s,a)=>{const f=s.senderId===n._id;return e.jsx(c,{display:"flex",justifyContent:f?"flex-end":"flex-start",mb:1,children:e.jsxs(c,{sx:{px:2,py:1.2,maxWidth:"75%",borderRadius:"18px",bgcolor:f?"#DCF8C6":"#fff",boxShadow:"0 1px 2px rgba(0,0,0,0.1)",wordBreak:"break-word"},children:[e.jsx(d,{variant:"body2",children:s.text}),e.jsx(d,{variant:"caption",sx:{display:"block",textAlign:"right",opacity:.6,mt:.5,fontSize:"0.7rem"},children:s.time||new Date(s.timestamp).toLocaleTimeString()})]})},a)}),e.jsx("div",{ref:b})]}),e.jsxs(z,{sx:{p:1.5,bgcolor:"#f7f7f7",borderTop:"1px solid #ddd",gap:1,flexShrink:0},children:[e.jsx(W,{sx:{color:"#888"}}),e.jsx(A,{fullWidth:!0,size:"small",placeholder:"Type a message...",value:i,onChange:s=>u(s.target.value),onKeyDown:w,multiline:!0,maxRows:3,disabled:!l,sx:{bgcolor:"#fff",borderRadius:"20px","& .MuiOutlinedInput-root":{borderRadius:"20px"}}}),e.jsx(C,{onClick:j,disabled:!i.trim(),sx:{bgcolor:i.trim()?"#25D366":"#ccc",color:"#fff","&:hover":{bgcolor:i.trim()?"#1ebd5a":"#ccc"}},size:"small",children:e.jsx(B,{})})]})]})};export{F as E};
