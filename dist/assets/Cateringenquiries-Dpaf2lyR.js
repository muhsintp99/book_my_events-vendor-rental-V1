import{r as o,j as e,a9 as U,aa as Y,S as Q,q as oe,B as m,T as c,b as I,ab as X,t as Z,ap as ee,ad as te,s as se,x as ie,a8 as le,aj as P,V as re,G as F,p as H,M as K,P as ae,ag as ce,av as de,g as G,ar as xe,h as J}from"./index-DaiSIVFY.js";import{C as $}from"./Chat-BxLLLM81.js";import{C as ne}from"./Close-nUc7dfNC.js";import{E as he}from"./Event-QnFhIpP6.js";import{C as fe}from"./Category-BQq9bSW4.js";import{A as ue}from"./AccessTime-C079Pa2C.js";import{C as me}from"./ChatBubbleOutline-CC5Q4fJ6.js";import{D as je}from"./DoneAll-B_eSXIVJ.js";import{S as pe}from"./Send-BHaMEiE8.js";import{s as i}from"./socket-BpXQx-Y7.js";import{T as ge}from"./TableContainer-CCxjY6st.js";import{T as Ce,a as q,b as a,c as be}from"./TableRow-ChIWNuSP.js";import{T as Se}from"./TableHead-DGuhomhg.js";const Ie=({open:j,onClose:L,enquiry:n})=>{var R,w;const[p,v]=o.useState(""),[E,b]=o.useState([]),[_,y]=o.useState(!1),[D,k]=o.useState(!1),z=o.useRef(null),C=JSON.parse(localStorage.getItem("user"))||{},T=C==null?void 0:C._id;o.useEffect(()=>{var s;(s=z.current)==null||s.scrollIntoView({behavior:"smooth"})},[E]),o.useEffect(()=>{var u;if(!j||!(n!=null&&n._id))return;y(!0);const s=n._id,x=C==null?void 0:C._id,g=((u=n.userId)==null?void 0:u._id)||n.userId;i.connected||i.connect();const r=()=>{k(!0),i.emit("join_enquiry",{enquiryId:s,vendorId:x,userId:g})},h=()=>{k(!1)},W=f=>{b(f||[]),y(!1)},t=f=>{b(A=>{const B=A.find(S=>{var V;return((V=S._id)==null?void 0:V.startsWith("temp-"))&&(S.message===f.message||S.text===f.message)&&String(S.senderId)===String(f.senderId)});return B?A.map(S=>S._id===B._id?f:S):[...A,f]})},l=({messageId:f})=>{b(A=>A.filter(B=>B._id!==f))};return i.on("connect",r),i.on("disconnect",h),i.on("message_history",W),i.on("receive_message",t),i.on("message_deleted",l),i.connected&&r(),()=>{i.off("connect",r),i.off("disconnect",h),i.off("message_history",W),i.off("receive_message",t),i.off("message_deleted",l)}},[j,n==null?void 0:n._id]);const d=()=>{var r;if(!p.trim())return;const s="temp-"+Date.now(),x=p,g={enquiryId:n._id,senderId:T,receiverId:((r=n.userId)==null?void 0:r._id)||n.userId,senderRole:"vendor",message:x,timestamp:new Date().toISOString()};b(h=>[...h,{...g,_id:s}]),v(""),i.connected&&i.emit("send_message",g)},N=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),d())},O=s=>{i.connected&&i.emit("delete_message",{messageId:s,enquiryId:n._id})},M=s=>String(s)===String(T);return n?e.jsxs(U,{open:j,onClose:L,fullWidth:!0,maxWidth:"sm",PaperProps:{sx:{height:"80vh",display:"flex",flexDirection:"column"}},children:[e.jsx(Y,{sx:{bgcolor:"#075E54",color:"#fff"},children:e.jsxs(Q,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(oe,{sx:{bgcolor:"#25D366"},children:((R=n.fullName)==null?void 0:R.charAt(0))||"C"}),e.jsxs(m,{flex:1,children:[e.jsx(c,{fontWeight:600,children:n.fullName}),e.jsxs(c,{variant:"caption",children:[(w=n.moduleId)==null?void 0:w.title,D&&" â€¢ Connected"]})]}),e.jsx(I,{onClick:L,sx:{color:"#fff"},children:e.jsx(ne,{})})]})}),e.jsxs(X,{sx:{flex:1,overflowY:"auto",bgcolor:"#ECE5DD",p:2},children:[_?e.jsx(m,{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",children:e.jsx(Z,{})}):E.length===0?e.jsx(c,{textAlign:"center",color:"text.secondary",children:"No messages yet. Start the conversation!"}):E.map(s=>{var r;const x=M(s.senderId),g=(r=s._id)==null?void 0:r.startsWith("temp-");return e.jsx(m,{display:"flex",justifyContent:x?"flex-end":"flex-start",mb:1,children:e.jsxs(m,{sx:{p:1.5,borderRadius:x?"15px 15px 2px 15px":"15px 15px 15px 2px",bgcolor:x?"#DCF8C6":"#fff",position:"relative",maxWidth:"75%",transition:"0.2s ease","&:hover .delete-btn":{opacity:1,transform:"scale(1)"}},children:[e.jsx(c,{variant:"body2",children:s.message||s.text}),x&&!g&&e.jsx(I,{className:"delete-btn",size:"small",onClick:()=>O(s._id),sx:{position:"absolute",top:-8,right:-8,bgcolor:"#ff4d4d",color:"#fff",p:.5,opacity:0,transform:"scale(0.8)",transition:"all 0.2s ease","&:hover":{bgcolor:"#cc0000"}},children:e.jsx(ee,{sx:{fontSize:12}})}),e.jsxs(c,{variant:"caption",sx:{display:"flex",alignItems:"center",justifyContent:"flex-end",gap:.5,mt:.5,fontSize:"0.65rem",color:"text.secondary"},children:[g?"sending...":e.jsx(je,{sx:{fontSize:12,color:"#4caf50"}}),new Date(s.timestamp||s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})},s._id)}),e.jsx("div",{ref:z})]}),e.jsxs(te,{sx:{p:1.5,bgcolor:"#f7f7f7"},children:[e.jsx(me,{sx:{color:"#888"}}),e.jsx(se,{fullWidth:!0,size:"small",placeholder:"Type a message...",value:p,onChange:s=>v(s.target.value),onKeyDown:N,multiline:!0,maxRows:3,disabled:!D,sx:{bgcolor:"#fff",borderRadius:"20px","& .MuiOutlinedInput-root":{borderRadius:"20px"}}}),e.jsx(I,{onClick:d,disabled:!p.trim()||!D,sx:{bgcolor:p.trim()&&D?"#25D366":"#ccc",color:"#fff","&:hover":{bgcolor:"#1ebd5a"}},children:e.jsx(pe,{})})]})]}):null},Ne=()=>{var W;const[j,L]=o.useState(""),[n,p]=o.useState([]),[v,E]=o.useState(!0),[b,_]=o.useState(null),[y,D]=o.useState(null),[k,z]=o.useState(""),[C,T]=o.useState(!1),[d,N]=o.useState(null),[O,M]=o.useState(!1),[R,w]=o.useState(null);o.useEffect(()=>{const t=localStorage.getItem("user");if(t){const l=JSON.parse(t);D(l.providerId||l._id)}},[]),o.useEffect(()=>{(async()=>{if(y)try{const l=await J.get(`https://api.bookmyevent.ae/api/enquiries/provider/${y}`);p(l.data.data||[]),_(null)}catch{_("Failed to fetch enquiries"),p([])}finally{E(!1)}})()},[y]);const s=async t=>{if(window.confirm("Are you sure you want to delete this enquiry?"))try{await J.delete(`https://api.bookmyevent.ae/api/enquiries/${t}`),p(u=>u.filter(f=>f._id!==t)),z("Enquiry deleted successfully")}catch{_("Failed to delete enquiry")}},x=n.filter(t=>{var l;return(t.fullName||"").toLowerCase().includes(j.toLowerCase())||(t.email||"").toLowerCase().includes(j.toLowerCase())||(t.contact||"").includes(j)||(((l=t.moduleId)==null?void 0:l.title)||"").toLowerCase().includes(j.toLowerCase())}),g=t=>{N(t),T(!0)},r=()=>{T(!1),N(null)},h=({icon:t,label:l,value:u})=>e.jsxs(m,{display:"flex",alignItems:"center",gap:2,py:1.5,sx:{borderBottom:"1px solid",borderColor:"divider","&:last-child":{borderBottom:"none"}},children:[e.jsx(m,{sx:{width:40,height:40,borderRadius:"50%",bgcolor:"primary.light",color:"primary.main",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:t}),e.jsxs(m,{children:[e.jsx(c,{variant:"caption",color:"text.secondary",children:l}),e.jsx(c,{fontWeight:500,children:u||"N/A"})]})]});return e.jsxs(m,{p:2,children:[e.jsx(c,{variant:"h4",gutterBottom:!0,children:"Enquiries"}),b&&e.jsx(ie,{severity:"error",sx:{mb:2},children:b}),e.jsxs(le,{sx:{mt:2},children:[e.jsx(m,{p:2,children:e.jsx(se,{label:"Search enquiries",size:"small",value:j,onChange:t=>L(t.target.value),fullWidth:!0})}),e.jsx(ge,{children:e.jsxs(Ce,{children:[e.jsx(Se,{children:e.jsxs(q,{children:[e.jsx(a,{children:"#"}),e.jsx(a,{children:"Customer"}),e.jsx(a,{children:"Module"}),e.jsx(a,{children:"Contact"}),e.jsx(a,{children:"Date"}),e.jsx(a,{align:"center",children:"Actions"})]})}),e.jsxs(be,{children:[v&&e.jsx(q,{children:e.jsx(a,{colSpan:6,align:"center",children:e.jsx(Z,{size:28})})}),!v&&x.map((t,l)=>{var u;return e.jsxs(q,{hover:!0,children:[e.jsx(a,{children:l+1}),e.jsxs(a,{children:[e.jsx(c,{fontWeight:600,children:t.fullName}),e.jsx(c,{variant:"caption",color:"text.secondary",children:t.email})]}),e.jsx(a,{children:(u=t.moduleId)==null?void 0:u.title}),e.jsx(a,{children:t.contact}),e.jsx(a,{children:new Date(t.bookingDate).toLocaleDateString()}),e.jsx(a,{align:"center",children:e.jsxs(Q,{direction:"row",spacing:1,justifyContent:"center",children:[e.jsx(P,{title:"Chat",children:e.jsx(I,{size:"small",color:"primary",onClick:()=>{w(t),M(!0)},children:e.jsx($,{fontSize:"small"})})}),e.jsx(P,{title:"View",children:e.jsx(I,{size:"small",color:"info",onClick:()=>g(t),children:e.jsx(re,{fontSize:"small"})})}),e.jsx(P,{title:"Delete",children:e.jsx(I,{size:"small",color:"error",onClick:()=>s(t._id),children:e.jsx(ee,{fontSize:"small"})})})]})})]},t._id)}),!v&&x.length===0&&e.jsx(q,{children:e.jsx(a,{colSpan:6,align:"center",children:"No enquiries found"})})]})]})})]}),e.jsxs(U,{open:C,onClose:r,maxWidth:"md",fullWidth:!0,children:[e.jsx(Y,{sx:{bgcolor:"primary.main",color:"white"},children:e.jsxs(m,{display:"flex",justifyContent:"space-between",children:[e.jsx(c,{fontWeight:600,children:"Enquiry Details"}),e.jsx(I,{onClick:r,sx:{color:"white"},children:e.jsx(ne,{})})]})}),e.jsx(X,{children:d&&e.jsxs(F,{container:!0,spacing:3,mt:1,children:[e.jsx(F,{item:!0,xs:12,md:6,children:e.jsx(H,{variant:"outlined",children:e.jsxs(K,{children:[e.jsx(c,{fontWeight:600,mb:2,children:"Customer Information"}),e.jsx(h,{icon:e.jsx(ae,{fontSize:"small"}),label:"Full Name",value:d.fullName}),e.jsx(h,{icon:e.jsx(ce,{fontSize:"small"}),label:"Email",value:d.email}),e.jsx(h,{icon:e.jsx(de,{fontSize:"small"}),label:"Contact",value:d.contact})]})})}),e.jsx(F,{item:!0,xs:12,md:6,children:e.jsx(H,{variant:"outlined",children:e.jsxs(K,{children:[e.jsx(c,{fontWeight:600,mb:2,children:"Booking Information"}),e.jsx(h,{icon:e.jsx(fe,{fontSize:"small"}),label:"Module",value:(W=d.moduleId)==null?void 0:W.title}),e.jsx(h,{icon:e.jsx(he,{fontSize:"small"}),label:"Booking Date",value:new Date(d.bookingDate).toLocaleDateString()}),e.jsx(h,{icon:e.jsx(ue,{fontSize:"small"}),label:"Created At",value:new Date(d.createdAt).toLocaleString()})]})})})]})}),e.jsxs(te,{children:[e.jsx(G,{onClick:r,variant:"outlined",children:"Close"}),e.jsx(G,{variant:"contained",startIcon:e.jsx($,{}),onClick:()=>{r(),w(d),M(!0)},children:"Open Chat"})]})]}),e.jsx(Ie,{open:O,onClose:()=>{M(!1),w(null)},enquiry:R}),e.jsx(xe,{open:!!k,autoHideDuration:3e3,onClose:()=>z(""),message:k})]})};export{Ne as default};
