import{r as l,j as e,H as $,a4 as Q,s as U,A as oe,B as h,T as d,o as S,J as X,c as Z,z as ee,K as te,a as se,d as ie,e as le,Y as re,a0 as O,V as ae,G as P,C as K,q as J,P as ce,ah as de,ag as xe,b as G,f as fe}from"./index-DQO8S-Hd.js";import{C as Y}from"./Chat-D6MMlLbx.js";import{C as ne}from"./Close-DxdnvH5I.js";import{E as he}from"./Event-CJTokCmx.js";import{C as ue}from"./Category-Bo9R6iVI.js";import{A as me}from"./AccessTime-BHwgTyxt.js";import{C as je}from"./ChatBubbleOutline-BFlJuwIJ.js";import{D as ge}from"./DoneAll-D7WuKBeD.js";import{s as i,S as pe}from"./socket-CBlX6k_4.js";import{T as Ce}from"./TableContainer-DPUflpAD.js";import{T as be,a as N,b as c,c as Ie}from"./TableRow-D3JAjirS.js";import{T as ve}from"./TableHead-N38RAP1I.js";const Se=({open:y,onClose:j,enquiry:n})=>{var w,M;const[p,E]=l.useState(""),[C,b]=l.useState([]),[k,D]=l.useState(!1),[g,T]=l.useState(!1),W=l.useRef(null),a=JSON.parse(localStorage.getItem("user"))||{},x=(a==null?void 0:a._id)||(a==null?void 0:a.providerId);l.useEffect(()=>{var s;(s=W.current)==null||s.scrollIntoView({behavior:"smooth"})},[C]),l.useEffect(()=>{var H;if(!y||!(n!=null&&n._id))return;D(!0);const s=n._id,o=(a==null?void 0:a._id)||(a==null?void 0:a.providerId),f=((H=n.userId)==null?void 0:H._id)||n.userId;i.connected||i.connect();const t=()=>{T(!0),i.emit("join_enquiry",{enquiryId:s,vendorId:o,userId:f})},r=()=>{T(!1)},I=m=>{b(m||[]),D(!1)},q=m=>{b(z=>{const L=z.find(v=>{var V;return((V=v._id)==null?void 0:V.startsWith("temp-"))&&(v.message===m.message||v.text===m.message)&&String(v.senderId)===String(m.senderId)});return L?z.map(v=>v._id===L._id?m:v):[...z,m]})},F=({messageId:m})=>{b(z=>z.filter(L=>L._id!==m))};return i.on("connect",t),i.on("disconnect",r),i.on("message_history",I),i.on("receive_message",q),i.on("message_deleted",F),i.connected&&t(),()=>{i.off("connect",t),i.off("disconnect",r),i.off("message_history",I),i.off("receive_message",q),i.off("message_deleted",F)}},[y,n==null?void 0:n._id]);const _=()=>{var t;if(!p.trim())return;const s="temp-"+Date.now(),o=p,f={enquiryId:n._id,senderId:x,receiverId:((t=n.userId)==null?void 0:t._id)||n.userId,senderRole:"vendor",message:o,timestamp:new Date().toISOString()};b(r=>[...r,{...f,_id:s}]),E(""),i.connected&&i.emit("send_message",f)},R=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),_())},A=s=>{i.connected&&i.emit("delete_message",{messageId:s,enquiryId:n._id})},B=s=>String(s)===String(x),u="#dd666eff";return n?e.jsxs($,{open:y,onClose:j,fullWidth:!0,maxWidth:"sm",PaperProps:{sx:{height:"80vh",display:"flex",flexDirection:"column"}},children:[e.jsx(Q,{sx:{bgcolor:u,color:"#fff"},children:e.jsxs(U,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(oe,{sx:{bgcolor:"#F1F5F9",color:u},children:((w=n.fullName)==null?void 0:w.charAt(0))||"C"}),e.jsxs(h,{flex:1,children:[e.jsx(d,{fontWeight:600,children:n.fullName}),e.jsxs(d,{variant:"caption",children:[(M=n.moduleId)==null?void 0:M.title,g&&" â€¢ Connected"]})]}),e.jsx(S,{onClick:j,sx:{color:"#fff"},children:e.jsx(ne,{})})]})}),e.jsxs(X,{sx:{flex:1,overflowY:"auto",bgcolor:"#f4f7fb",p:2},children:[k?e.jsx(h,{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",children:e.jsx(Z,{sx:{color:u}})}):C.length===0?e.jsx(d,{textAlign:"center",color:"text.secondary",children:"No messages yet. Start the conversation!"}):C.map(s=>{var t;const o=B(s.senderId),f=(t=s._id)==null?void 0:t.startsWith("temp-");return e.jsx(h,{display:"flex",justifyContent:o?"flex-end":"flex-start",mb:1,children:e.jsxs(h,{sx:{p:1.5,borderRadius:o?"15px 15px 2px 15px":"15px 15px 15px 2px",bgcolor:o?u:"#fff",color:o?"#fff":"inherit",position:"relative",maxWidth:"75%",transition:"0.2s ease","&:hover .delete-btn":{opacity:1,transform:"scale(1)"}},children:[e.jsx(d,{variant:"body2",children:s.message||s.text}),o&&!f&&e.jsx(S,{className:"delete-btn",size:"small",onClick:()=>A(s._id),sx:{position:"absolute",top:-8,right:-8,bgcolor:"#ff4d4d",color:"#fff",p:.5,opacity:0,transform:"scale(0.8)",transition:"all 0.2s ease","&:hover":{bgcolor:"#cc0000"}},children:e.jsx(ee,{sx:{fontSize:12}})}),e.jsxs(d,{variant:"caption",sx:{display:"flex",alignItems:"center",justifyContent:"flex-end",gap:.5,mt:.5,fontSize:"0.65rem",color:o?"rgba(255,255,255,0.7)":"text.secondary"},children:[f?"sending...":e.jsx(ge,{sx:{fontSize:12,color:o?"#fff":"#4caf50"}}),new Date(s.timestamp||s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})},s._id)}),e.jsx("div",{ref:W})]}),e.jsxs(te,{sx:{p:1.5,bgcolor:"#fff"},children:[e.jsx(je,{sx:{color:"#888"}}),e.jsx(se,{fullWidth:!0,size:"small",placeholder:"Type a message...",value:p,onChange:s=>E(s.target.value),onKeyDown:R,multiline:!0,maxRows:3,disabled:!g,sx:{bgcolor:"#fff",borderRadius:"20px","& .MuiOutlinedInput-root":{borderRadius:"20px"}}}),e.jsx(S,{onClick:_,disabled:!p.trim()||!g,sx:{bgcolor:p.trim()&&g?u:"#ccc",color:"#fff","&:hover":{bgcolor:u}},children:e.jsx(pe,{})})]})]}):null},Ne=()=>{var f;const y=ie(),[j,n]=l.useState(""),[p,E]=l.useState([]),[C,b]=l.useState(!0),[k,D]=l.useState(null),[g,T]=l.useState(null),[W,a]=l.useState(!1),[x,_]=l.useState(null),[R,A]=l.useState(!1),[B,u]=l.useState(null);l.useEffect(()=>{const t=localStorage.getItem("user");if(t){const r=JSON.parse(t);T(r.providerId||r._id)}},[]),l.useEffect(()=>{(async()=>{if(!g){D("Provider ID not found"),b(!1);return}try{const r=await fe.get(`https://api.bookmyevent.ae/api/enquiries/provider/${g}`);E(r.data.data||[]),D(null)}catch{D("Failed to fetch enquiries"),E([])}finally{b(!1)}})()},[g]);const w=p.filter(t=>{var r;return(t.fullName||"").toLowerCase().includes(j.toLowerCase())||(t.email||"").toLowerCase().includes(j.toLowerCase())||(t.contact||"").includes(j)||(((r=t.moduleId)==null?void 0:r.title)||"").toLowerCase().includes(j.toLowerCase())}),M=t=>{_(t),a(!0)},s=()=>{a(!1),_(null)},o=({icon:t,label:r,value:I})=>e.jsxs(h,{display:"flex",alignItems:"center",gap:2,py:1.5,sx:{borderBottom:"1px solid",borderColor:"divider","&:last-child":{borderBottom:"none"}},children:[e.jsx(h,{sx:{width:40,height:40,borderRadius:"50%",bgcolor:"primary.light",color:"primary.main",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:t}),e.jsxs(h,{children:[e.jsx(d,{variant:"caption",color:"text.secondary",children:r}),e.jsx(d,{fontWeight:500,children:I||"N/A"})]})]});return e.jsxs(h,{p:2,children:[e.jsx(d,{variant:"h4",gutterBottom:!0,sx:{color:"#dd666eff",fontWeight:700},children:"Emcee & Event Host Enquiries"}),k&&e.jsx(le,{severity:"error",sx:{mb:2},children:k}),e.jsxs(re,{sx:{mt:2},children:[e.jsx(h,{p:2,children:e.jsx(se,{label:"Search enquiries",size:"small",value:j,onChange:t=>n(t.target.value),fullWidth:!0})}),e.jsx(Ce,{children:e.jsxs(be,{children:[e.jsx(ve,{children:e.jsxs(N,{children:[e.jsx(c,{children:"#"}),e.jsx(c,{children:"Customer"}),e.jsx(c,{children:"Module"}),e.jsx(c,{children:"Contact"}),e.jsx(c,{children:"Date"}),e.jsx(c,{align:"center",children:"Actions"})]})}),e.jsxs(Ie,{children:[C&&e.jsx(N,{children:e.jsx(c,{colSpan:6,align:"center",children:e.jsx(Z,{size:28})})}),!C&&w.map((t,r)=>{var I;return e.jsxs(N,{hover:!0,children:[e.jsx(c,{children:r+1}),e.jsxs(c,{children:[e.jsx(d,{fontWeight:600,children:t.fullName}),e.jsx(d,{variant:"caption",color:"text.secondary",children:t.email})]}),e.jsx(c,{children:(I=t.moduleId)==null?void 0:I.title}),e.jsx(c,{children:t.contact}),e.jsx(c,{children:new Date(t.bookingDate).toLocaleDateString()}),e.jsx(c,{align:"center",children:e.jsxs(U,{direction:"row",spacing:1,justifyContent:"center",children:[e.jsx(O,{title:"Chat",children:e.jsx(S,{size:"small",color:"primary",onClick:()=>{y("/emcee/enquirychat",{state:{enquiry:t}})},children:e.jsx(Y,{fontSize:"small"})})}),e.jsx(O,{title:"View",children:e.jsx(S,{size:"small",color:"info",onClick:()=>M(t),children:e.jsx(ae,{fontSize:"small"})})}),e.jsx(O,{title:"Delete",children:e.jsx(S,{size:"small",color:"error",children:e.jsx(ee,{fontSize:"small"})})})]})})]},t._id)}),!C&&w.length===0&&e.jsx(N,{children:e.jsx(c,{colSpan:6,align:"center",children:"No enquiries found"})})]})]})})]}),e.jsxs($,{open:W,onClose:s,maxWidth:"md",fullWidth:!0,children:[e.jsx(Q,{sx:{bgcolor:"#dd666eff",color:"white"},children:e.jsxs(h,{display:"flex",justifyContent:"space-between",children:[e.jsx(d,{fontWeight:600,children:"Enquiry Details"}),e.jsx(S,{onClick:s,sx:{color:"white"},children:e.jsx(ne,{})})]})}),e.jsx(X,{children:x&&e.jsxs(P,{container:!0,spacing:3,mt:1,children:[e.jsx(P,{item:!0,xs:12,md:6,children:e.jsx(K,{variant:"outlined",children:e.jsxs(J,{children:[e.jsx(d,{fontWeight:600,mb:2,children:"Customer Information"}),e.jsx(o,{icon:e.jsx(ce,{fontSize:"small"}),label:"Full Name",value:x.fullName}),e.jsx(o,{icon:e.jsx(de,{fontSize:"small"}),label:"Email",value:x.email}),e.jsx(o,{icon:e.jsx(xe,{fontSize:"small"}),label:"Contact",value:x.contact})]})})}),e.jsx(P,{item:!0,xs:12,md:6,children:e.jsx(K,{variant:"outlined",children:e.jsxs(J,{children:[e.jsx(d,{fontWeight:600,mb:2,children:"Booking Information"}),e.jsx(o,{icon:e.jsx(ue,{fontSize:"small"}),label:"Module",value:(f=x.moduleId)==null?void 0:f.title}),e.jsx(o,{icon:e.jsx(he,{fontSize:"small"}),label:"Booking Date",value:new Date(x.bookingDate).toLocaleDateString()}),e.jsx(o,{icon:e.jsx(me,{fontSize:"small"}),label:"Created At",value:new Date(x.createdAt).toLocaleString()})]})})})]})}),e.jsxs(te,{children:[e.jsx(G,{onClick:s,variant:"outlined",children:"Close"}),e.jsx(G,{variant:"contained",startIcon:e.jsx(Y,{}),sx:{bgcolor:"#dd666eff","&:hover":{bgcolor:"#ad2430ff"}},onClick:()=>{u(x),A(!0),y("/emcee/enquirychat",{state:{enquiry:x}})},children:"Open Chat"})]})]}),e.jsx(Se,{open:R,onClose:()=>{A(!1),u(null)},enquiry:B})]})};export{Ne as default};
