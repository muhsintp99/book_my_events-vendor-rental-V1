import{r as i,j as e,H as Y,a4 as U,s as $,A as ne,B as f,T as c,o as v,J as Q,c as X,z as Z,K as ee,a as te,d as oe,e as ie,Y as le,a0 as P,V as re,G as q,C as K,q as H,P as ae,ai as ce,ah as de,b as J,f as xe}from"./index-BPglAkNh.js";import{C as G}from"./Chat-BVHN0qno.js";import{C as se}from"./Close-CemJsPGu.js";import{E as he}from"./Event-C846CFZc.js";import{C as fe}from"./Category-CsGvn_Pw.js";import{A as ue}from"./AccessTime-DIVz7IPl.js";import{C as me}from"./ChatBubbleOutline-Ca0mJNKX.js";import{D as je}from"./DoneAll-7ZPDchuu.js";import{s as o,S as pe}from"./socket-DYxBQp-t.js";import{T as ge}from"./TableContainer-zMuQg4uS.js";import{T as Ce,a as L,b as a,c as be}from"./TableRow-BYYpuKk3.js";import{T as Se}from"./TableHead-DdSuxs4C.js";const Ie=({open:y,onClose:j,enquiry:n})=>{var _,k;const[g,E]=i.useState(""),[C,b]=i.useState([]),[T,D]=i.useState(!1),[p,W]=i.useState(!1),A=i.useRef(null),u=JSON.parse(localStorage.getItem("user"))||{},d=u==null?void 0:u._id;i.useEffect(()=>{var s;(s=A.current)==null||s.scrollIntoView({behavior:"smooth"})},[C]),i.useEffect(()=>{var V;if(!y||!(n!=null&&n._id))return;D(!0);const s=n._id,x=u==null?void 0:u._id,r=((V=n.userId)==null?void 0:V._id)||n.userId;o.connected||o.connect();const h=()=>{W(!0),o.emit("join_enquiry",{enquiryId:s,vendorId:x,userId:r})},t=()=>{W(!1)},l=m=>{b(m||[]),D(!1)},S=m=>{b(z=>{const N=z.find(I=>{var F;return((F=I._id)==null?void 0:F.startsWith("temp-"))&&(I.message===m.message||I.text===m.message)&&String(I.senderId)===String(m.senderId)});return N?z.map(I=>I._id===N._id?m:I):[...z,m]})},O=({messageId:m})=>{b(z=>z.filter(N=>N._id!==m))};return o.on("connect",h),o.on("disconnect",t),o.on("message_history",l),o.on("receive_message",S),o.on("message_deleted",O),o.connected&&h(),()=>{o.off("connect",h),o.off("disconnect",t),o.off("message_history",l),o.off("receive_message",S),o.off("message_deleted",O)}},[y,n==null?void 0:n._id]);const w=()=>{var h;if(!g.trim())return;const s="temp-"+Date.now(),x=g,r={enquiryId:n._id,senderId:d,receiverId:((h=n.userId)==null?void 0:h._id)||n.userId,senderRole:"vendor",message:x,timestamp:new Date().toISOString()};b(t=>[...t,{...r,_id:s}]),E(""),o.connected&&o.emit("send_message",r)},R=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),w())},M=s=>{o.connected&&o.emit("delete_message",{messageId:s,enquiryId:n._id})},B=s=>String(s)===String(d);return n?e.jsxs(Y,{open:y,onClose:j,fullWidth:!0,maxWidth:"sm",PaperProps:{sx:{height:"80vh",display:"flex",flexDirection:"column"}},children:[e.jsx(U,{sx:{bgcolor:"#075E54",color:"#fff"},children:e.jsxs($,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(ne,{sx:{bgcolor:"#25D366"},children:((_=n.fullName)==null?void 0:_.charAt(0))||"C"}),e.jsxs(f,{flex:1,children:[e.jsx(c,{fontWeight:600,children:n.fullName}),e.jsxs(c,{variant:"caption",children:[(k=n.moduleId)==null?void 0:k.title,p&&" â€¢ Connected"]})]}),e.jsx(v,{onClick:j,sx:{color:"#fff"},children:e.jsx(se,{})})]})}),e.jsxs(Q,{sx:{flex:1,overflowY:"auto",bgcolor:"#ECE5DD",p:2},children:[T?e.jsx(f,{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",children:e.jsx(X,{})}):C.length===0?e.jsx(c,{textAlign:"center",color:"text.secondary",children:"No messages yet. Start the conversation!"}):C.map(s=>{var h;const x=B(s.senderId),r=(h=s._id)==null?void 0:h.startsWith("temp-");return e.jsx(f,{display:"flex",justifyContent:x?"flex-end":"flex-start",mb:1,children:e.jsxs(f,{sx:{p:1.5,borderRadius:x?"15px 15px 2px 15px":"15px 15px 15px 2px",bgcolor:x?"#DCF8C6":"#fff",position:"relative",maxWidth:"75%",transition:"0.2s ease","&:hover .delete-btn":{opacity:1,transform:"scale(1)"}},children:[e.jsx(c,{variant:"body2",children:s.message||s.text}),x&&!r&&e.jsx(v,{className:"delete-btn",size:"small",onClick:()=>M(s._id),sx:{position:"absolute",top:-8,right:-8,bgcolor:"#ff4d4d",color:"#fff",p:.5,opacity:0,transform:"scale(0.8)",transition:"all 0.2s ease","&:hover":{bgcolor:"#cc0000"}},children:e.jsx(Z,{sx:{fontSize:12}})}),e.jsxs(c,{variant:"caption",sx:{display:"flex",alignItems:"center",justifyContent:"flex-end",gap:.5,mt:.5,fontSize:"0.65rem",color:"text.secondary"},children:[r?"sending...":e.jsx(je,{sx:{fontSize:12,color:"#4caf50"}}),new Date(s.timestamp||s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})},s._id)}),e.jsx("div",{ref:A})]}),e.jsxs(ee,{sx:{p:1.5,bgcolor:"#f7f7f7"},children:[e.jsx(me,{sx:{color:"#888"}}),e.jsx(te,{fullWidth:!0,size:"small",placeholder:"Type a message...",value:g,onChange:s=>E(s.target.value),onKeyDown:R,multiline:!0,maxRows:3,disabled:!p,sx:{bgcolor:"#fff",borderRadius:"20px","& .MuiOutlinedInput-root":{borderRadius:"20px"}}}),e.jsx(v,{onClick:w,disabled:!g.trim()||!p,sx:{bgcolor:g.trim()&&p?"#25D366":"#ccc",color:"#fff","&:hover":{bgcolor:"#1ebd5a"}},children:e.jsx(pe,{})})]})]}):null},Ne=()=>{var h;const y=oe(),[j,n]=i.useState(""),[g,E]=i.useState([]),[C,b]=i.useState(!0),[T,D]=i.useState(null),[p,W]=i.useState(null),[A,u]=i.useState(!1),[d,w]=i.useState(null),[R,M]=i.useState(!1),[B,_]=i.useState(null);i.useEffect(()=>{const t=localStorage.getItem("user");if(t){const l=JSON.parse(t);W(l.providerId||l._id)}},[]),i.useEffect(()=>{(async()=>{if(!p){D("Provider ID not found"),b(!1);return}try{const l=await xe.get(`https://api.bookmyevent.ae/api/enquiries/provider/${p}`);E(l.data.data||[]),D(null)}catch{D("Failed to fetch enquiries"),E([])}finally{b(!1)}})()},[p]);const k=g.filter(t=>{var l;return(t.fullName||"").toLowerCase().includes(j.toLowerCase())||(t.email||"").toLowerCase().includes(j.toLowerCase())||(t.contact||"").includes(j)||(((l=t.moduleId)==null?void 0:l.title)||"").toLowerCase().includes(j.toLowerCase())}),s=t=>{w(t),u(!0)},x=()=>{u(!1),w(null)},r=({icon:t,label:l,value:S})=>e.jsxs(f,{display:"flex",alignItems:"center",gap:2,py:1.5,sx:{borderBottom:"1px solid",borderColor:"divider","&:last-child":{borderBottom:"none"}},children:[e.jsx(f,{sx:{width:40,height:40,borderRadius:"50%",bgcolor:"primary.light",color:"primary.main",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:t}),e.jsxs(f,{children:[e.jsx(c,{variant:"caption",color:"text.secondary",children:l}),e.jsx(c,{fontWeight:500,children:S||"N/A"})]})]});return e.jsxs(f,{p:2,children:[e.jsx(c,{variant:"h4",gutterBottom:!0,children:"Enquiries"}),T&&e.jsx(ie,{severity:"error",sx:{mb:2},children:T}),e.jsxs(le,{sx:{mt:2},children:[e.jsx(f,{p:2,children:e.jsx(te,{label:"Search enquiries",size:"small",value:j,onChange:t=>n(t.target.value),fullWidth:!0})}),e.jsx(ge,{children:e.jsxs(Ce,{children:[e.jsx(Se,{children:e.jsxs(L,{children:[e.jsx(a,{children:"#"}),e.jsx(a,{children:"Customer"}),e.jsx(a,{children:"Module"}),e.jsx(a,{children:"Contact"}),e.jsx(a,{children:"Date"}),e.jsx(a,{align:"center",children:"Actions"})]})}),e.jsxs(be,{children:[C&&e.jsx(L,{children:e.jsx(a,{colSpan:6,align:"center",children:e.jsx(X,{size:28})})}),!C&&k.map((t,l)=>{var S;return e.jsxs(L,{hover:!0,children:[e.jsx(a,{children:l+1}),e.jsxs(a,{children:[e.jsx(c,{fontWeight:600,children:t.fullName}),e.jsx(c,{variant:"caption",color:"text.secondary",children:t.email})]}),e.jsx(a,{children:(S=t.moduleId)==null?void 0:S.title}),e.jsx(a,{children:t.contact}),e.jsx(a,{children:new Date(t.bookingDate).toLocaleDateString()}),e.jsx(a,{align:"center",children:e.jsxs($,{direction:"row",spacing:1,justifyContent:"center",children:[e.jsx(P,{title:"Chat",children:e.jsx(v,{size:"small",color:"primary",onClick:()=>{y("/makeupartist/enquirychat",{state:{enquiry:t}})},children:e.jsx(G,{fontSize:"small"})})}),e.jsx(P,{title:"View",children:e.jsx(v,{size:"small",color:"info",onClick:()=>s(t),children:e.jsx(re,{fontSize:"small"})})}),e.jsx(P,{title:"Delete",children:e.jsx(v,{size:"small",color:"error",children:e.jsx(Z,{fontSize:"small"})})})]})})]},t._id)}),!C&&k.length===0&&e.jsx(L,{children:e.jsx(a,{colSpan:6,align:"center",children:"No enquiries found"})})]})]})})]}),e.jsxs(Y,{open:A,onClose:x,maxWidth:"md",fullWidth:!0,children:[e.jsx(U,{sx:{bgcolor:"primary.main",color:"white"},children:e.jsxs(f,{display:"flex",justifyContent:"space-between",children:[e.jsx(c,{fontWeight:600,children:"Enquiry Details"}),e.jsx(v,{onClick:x,sx:{color:"white"},children:e.jsx(se,{})})]})}),e.jsx(Q,{children:d&&e.jsxs(q,{container:!0,spacing:3,mt:1,children:[e.jsx(q,{item:!0,xs:12,md:6,children:e.jsx(K,{variant:"outlined",children:e.jsxs(H,{children:[e.jsx(c,{fontWeight:600,mb:2,children:"Customer Information"}),e.jsx(r,{icon:e.jsx(ae,{fontSize:"small"}),label:"Full Name",value:d.fullName}),e.jsx(r,{icon:e.jsx(ce,{fontSize:"small"}),label:"Email",value:d.email}),e.jsx(r,{icon:e.jsx(de,{fontSize:"small"}),label:"Contact",value:d.contact})]})})}),e.jsx(q,{item:!0,xs:12,md:6,children:e.jsx(K,{variant:"outlined",children:e.jsxs(H,{children:[e.jsx(c,{fontWeight:600,mb:2,children:"Booking Information"}),e.jsx(r,{icon:e.jsx(fe,{fontSize:"small"}),label:"Module",value:(h=d.moduleId)==null?void 0:h.title}),e.jsx(r,{icon:e.jsx(he,{fontSize:"small"}),label:"Booking Date",value:new Date(d.bookingDate).toLocaleDateString()}),e.jsx(r,{icon:e.jsx(ue,{fontSize:"small"}),label:"Created At",value:new Date(d.createdAt).toLocaleString()})]})})})]})}),e.jsxs(ee,{children:[e.jsx(J,{onClick:x,variant:"outlined",children:"Close"}),e.jsx(J,{variant:"contained",startIcon:e.jsx(G,{}),onClick:()=>{_(d),M(!0),y("/makeupartist/enquirychat",{state:{enquiry:d}})},children:"Open Chat"})]})]}),e.jsx(Ie,{open:R,onClose:()=>{M(!1),_(null)},enquiry:B})]})};export{Ne as default};
