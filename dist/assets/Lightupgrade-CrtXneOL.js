import{r as m,j as e,B as g,c as te,T as i,e as R,G as _,C as M,q as $,w as k,a2 as T,s as U,X as z,b as E,N as se,f as j}from"./index-DQO8S-Hd.js";import{W as re}from"./WorkspacePremium-DR6obUAn.js";const A=120,W=3,I="https://api.bookmyevent.ae",c="#673ab7",oe="#5e35b1";function ce(){var L;const[N,H]=m.useState([]),[O,B]=m.useState(!0),[F,D]=m.useState(null),[V,J]=m.useState(null),[X,Y]=m.useState(null),[S,u]=m.useState({open:!1,message:"",severity:"info"}),[h,C]=m.useState(null),[G,w]=m.useState(!0),y=localStorage.getItem("moduleId"),v=JSON.parse(localStorage.getItem("user")||"{}"),b=v==null?void 0:v._id;m.useEffect(()=>{const a=new URLSearchParams(window.location.search).get("orderId");if(!a){w(!1);return}(async()=>{var l,r,n,s;try{u({open:!0,message:"Verifying payment...",severity:"info"});const o=await j.post(`${I}/api/payment/verify-subscription-payment`,{orderId:a});if(o.data.success){u({open:!0,message:"ðŸŽ‰ Premium Plan Activated!",severity:"success"});const p=typeof o.data.subscription.moduleId=="object"&&((l=o.data.subscription.moduleId)==null?void 0:l._id)||o.data.subscription.moduleId,x=await j.get(`${I}/api/subscription/status/${b}?moduleId=${p}`);if(x.data.success&&x.data.subscription){const d=x.data.subscription,P=typeof d.moduleId=="object"&&((r=d.moduleId)==null?void 0:r._id)||d.moduleId;localStorage.setItem("moduleId",P);const Z=new Date(d.endDate),ee=Math.max(0,Math.ceil((Z-new Date)/(1e3*60*60*24)));localStorage.setItem("upgrade",JSON.stringify({isSubscribed:!0,status:"active",plan:d.planId,module:P,access:{canAccess:!0,isExpired:!1,daysLeft:ee}})),C(d),window.history.replaceState({},"",window.location.pathname),setTimeout(()=>{window.location.replace("/light/portfolio")},2e3)}}else u({open:!0,message:o.data.message||"Payment verification failed",severity:"error"})}catch(o){console.error("âŒ Payment verification error:",o),u({open:!0,message:((s=(n=o.response)==null?void 0:n.data)==null?void 0:s.message)||"Payment verification failed",severity:"error"})}finally{w(!1)}})()},[b,y]),m.useEffect(()=>{if(new URLSearchParams(window.location.search).get("orderId"))return;const a=localStorage.getItem("moduleId"),f=r=>{var n;try{const s=JSON.parse(localStorage.getItem("upgrade")||"{}"),o=typeof(s==null?void 0:s.module)=="object"?(n=s==null?void 0:s.module)==null?void 0:n._id:s==null?void 0:s.module;if((s==null?void 0:s.status)==="active"&&o===r)return C({status:"active",isCurrent:!0,planId:s==null?void 0:s.plan,moduleId:o}),!0}catch(s){console.error("localStorage parse error:",s)}return!1};(async()=>{var n;const r=a||y;if(!b||!r){f(r),w(!1);return}try{const s=await j.get(`${I}/api/subscription/status/${b}?moduleId=${r}`);if(s.data.success&&s.data.subscription){const o=s.data.subscription;if(o.status==="active"&&o.isCurrent){const p=typeof o.moduleId=="object"&&((n=o.moduleId)==null?void 0:n._id)||o.moduleId,x=new Date(o.endDate),P=Math.max(0,Math.ceil((x-new Date)/(1e3*60*60*24)));localStorage.setItem("upgrade",JSON.stringify({isSubscribed:!0,status:"active",plan:o.planId,module:p,access:{canAccess:!0,isExpired:!1,daysLeft:P}})),localStorage.setItem("moduleId",p),C(o),w(!1);return}}f(r)}catch(s){console.error("âŒ API error:",s.message),f(r)}finally{w(!1)}})()},[b,y]),m.useEffect(()=>{y&&(async()=>{try{const a=await j.get(`${I}/api/subscription/plan/module/${y}`);H(a.data.plans||[])}catch{u({open:!0,message:"Failed to load plans",severity:"error"})}finally{B(!1)}})()},[y]);const q=()=>new Promise(t=>{if(window.Razorpay){t(!0);return}const a=document.createElement("script");a.src="https://checkout.razorpay.com/v1/checkout.js",a.async=!0,a.onload=()=>t(!0),a.onerror=()=>t(!1),document.body.appendChild(a)}),K=async t=>{if(!b||!y){u({open:!0,message:"User or module missing",severity:"warning"});return}try{if(D(t._id),!await q())throw new Error("Razorpay SDK failed to load");const f=await j.post(`${I}/api/razorpay/subscription/create`,{providerId:b,planId:t._id,customerEmail:v.email,customerPhone:v.mobile||"9999999999"}),{razorpay:l,customer:r}=f.data;if(!(l!=null&&l.subscriptionId))throw new Error("Subscription ID missing from backend");const n={key:l.key,subscription_id:l.subscriptionId,name:"Book My Event",description:`${t.name} Subscription`,image:"/logo.png",handler:async function(o){var p,x;try{if((await j.post(`${I}/api/razorpay/subscription/verify`,o)).data.success)u({open:!0,message:"ðŸŽ‰ Subscription Activated!",severity:"success"}),setTimeout(()=>{window.location.replace("/light/portfolio")},1500);else throw new Error("Verification failed")}catch(d){console.error("âŒ Verification error:",d),u({open:!0,message:((x=(p=d.response)==null?void 0:p.data)==null?void 0:x.message)||"Payment verification failed",severity:"error"})}},prefill:{email:r.email,contact:r.phone},theme:{color:c}};new window.Razorpay(n).open()}catch(a){console.error("âŒ Razorpay Error:",a),u({open:!0,message:a.message||"Payment failed",severity:"error"}),D(null)}};if(O||G)return e.jsx(g,{sx:{minHeight:"100vh",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(te,{sx:{color:c}})});const Q=t=>{var a;return((a=h==null?void 0:h.planId)==null?void 0:a._id)===t};return e.jsxs(g,{sx:{minHeight:"100vh",bgcolor:"#f9fafc",py:6},children:[e.jsxs(g,{maxWidth:"md",mx:"auto",px:2,children:[e.jsx(i,{variant:"h4",fontWeight:800,textAlign:"center",children:h?"Manage Your Plan":"Upgrade Your Plan"}),e.jsx(i,{textAlign:"center",color:"text.secondary",mb:3,children:"Choose the best plan for your Light & Sound business"}),h?e.jsxs(R,{severity:"success",sx:{mb:4,border:`1px solid ${c}`,bgcolor:"#f3e5f5"},children:["Current Plan: ",e.jsx("b",{children:((L=h.planId)==null?void 0:L.name)||"PREMIUM"})]}):e.jsxs(R,{severity:"info",sx:{mb:4,border:"1px solid #2196f3"},children:["Current Plan: ",e.jsx("b",{children:"FREE"})," - Upgrade to unlock premium features"]}),e.jsxs(_,{container:!0,spacing:3,justifyContent:"center",children:[!h&&e.jsx(_,{item:!0,xs:12,md:6,children:e.jsx(M,{sx:{height:"100%",borderRadius:4,border:"2px solid #e0e0e0",boxShadow:"0 2px 8px rgba(0,0,0,0.1)"},children:e.jsxs($,{children:[e.jsx(k,{label:"CURRENT PLAN",sx:{bgcolor:"#9e9e9e",color:"#fff",mb:2}}),e.jsx(i,{variant:"h6",fontWeight:800,children:"FREE"}),e.jsx(i,{color:"text.secondary",sx:{minHeight:48},children:"Basic access to get started on the platform"}),e.jsx(i,{variant:"h4",fontWeight:900,color:"#9e9e9e",mt:2,children:"â‚¹0"}),e.jsx(T,{sx:{my:2}}),e.jsx(U,{spacing:1,children:["Limited listings","Basic visibility","Standard support"].map(t=>e.jsxs(g,{display:"flex",alignItems:"center",children:[e.jsx(z,{sx:{color:"#9e9e9e",mr:1,fontSize:20}}),e.jsx(i,{variant:"body2",children:t})]},t))}),e.jsx(E,{fullWidth:!0,disabled:!0,sx:{mt:3,bgcolor:"#e0e0e0",color:"#757575",fontWeight:700,borderRadius:2,textTransform:"none"},children:"Current Plan"})]})})}),N.map(t=>{var n,s;const a=V===t._id,f=X===t._id,l=F===t._id,r=Q(t._id);return e.jsx(_,{item:!0,xs:12,md:6,children:e.jsx(M,{sx:{height:"100%",borderRadius:4,border:r?"3px solid #4caf50":`3px solid ${c}`,boxShadow:r?"0 4px 20px rgba(76, 175, 80, 0.2)":`0 4px 20px ${alpha(c,.2)}`},children:e.jsxs($,{children:[e.jsx(k,{icon:r?e.jsx(z,{}):e.jsx(re,{}),label:r?"CURRENT PLAN":"BEST VALUE",sx:{bgcolor:r?"#4caf50":c,color:"#fff",mb:2,fontWeight:700}}),e.jsx(i,{variant:"h6",fontWeight:800,color:r?"#4caf50":c,children:t.name}),e.jsxs(i,{color:"text.secondary",sx:{minHeight:48},children:[a?t.description:((n=t.description)==null?void 0:n.length)>A?`${t.description.slice(0,A)}...`:t.description,((s=t.description)==null?void 0:s.length)>A&&e.jsx(E,{size:"small",onClick:()=>J(a?null:t._id),sx:{textTransform:"none",fontWeight:600,color:c,p:0,minWidth:"auto",ml:.5},children:a?"Read less":"Read more"})]}),e.jsxs(g,{sx:{mt:2},children:[e.jsx(k,{label:"ðŸŽ‰ Pre-Launch Offer",sx:{bgcolor:"#f3e5f5",color:c,fontWeight:700,mb:1}}),e.jsxs(g,{sx:{display:"flex",alignItems:"baseline",gap:2},children:[e.jsx(i,{sx:{textDecoration:"line-through",color:"#9ca3af",fontSize:18,fontWeight:600},children:"â‚¹20,000"}),e.jsxs(i,{sx:{fontSize:32,fontWeight:900,color:r?"#4caf50":c},children:["â‚¹",t.price]}),e.jsx(i,{sx:{fontSize:14,color:"text.secondary"},children:"/ year"})]}),e.jsx(i,{sx:{fontSize:13,color:"#6b7280",mt:.5},children:"Limited time launch offer for early partners"})]}),e.jsx(T,{sx:{my:2}}),e.jsx(U,{spacing:1,children:(f?t.features:t.features.slice(0,W)).map((o,p)=>e.jsxs(g,{display:"flex",alignItems:"flex-start",children:[e.jsx(z,{sx:{color:r?"#4caf50":c,mr:1,mt:.3,fontSize:20}}),e.jsx(i,{variant:"body2",children:o})]},p))}),t.features.length>W&&e.jsx(E,{size:"small",onClick:()=>Y(f?null:t._id),sx:{mt:1,textTransform:"none",fontWeight:600,color:c,p:0},children:f?"Show less":`+${t.features.length-W} more features`}),e.jsx(E,{fullWidth:!0,disabled:l||r,onClick:()=>K(t),sx:{mt:3,bgcolor:r?"#e0e0e0":c,color:r?"#757575":"#fff",fontWeight:800,borderRadius:2,py:1.5,textTransform:"none",fontSize:16,"&:hover":{bgcolor:r?"#e0e0e0":oe},"&:disabled":{bgcolor:"#e0e0e0"}},children:r?"Current Plan":l?"Redirecting...":h?"Switch Plan":"Upgrade To Premium"})]})})},t._id)})]}),e.jsx(g,{sx:{mt:4,p:2,bgcolor:"#f3e5f5",borderRadius:2,border:"1px solid #d1c4e9"},children:e.jsxs(i,{variant:"body2",color:"text.secondary",textAlign:"center",children:["ðŸ’¡ ",e.jsx("strong",{children:"Note:"}),` After clicking "Upgrade To Premium", you'll be redirected to a secure payment page. Your subscription will be activated immediately after successful payment.`]})})]}),e.jsx(se,{open:S.open,autoHideDuration:4e3,onClose:()=>u({...S,open:!1}),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(R,{onClose:()=>u({...S,open:!1}),severity:S.severity,sx:{width:"100%"},children:S.message})})]})}export{ce as default};
