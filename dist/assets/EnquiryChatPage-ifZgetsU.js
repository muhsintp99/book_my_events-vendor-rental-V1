import{a9 as re,w as ie,u as se,i as oe,r as c,j as e,B as a,S as y,T as d,b as v,al as _,at as ne,t as G,a1 as ae,au as le,av as ce,q as P,a2 as de,R as xe,aa as ue,ae as fe,s as he,D as me,h as U}from"./index-D2YhpxGZ.js";import{s as m,S as pe}from"./socket-C67GS0s4.js";import{D as ge}from"./DoneAll-D_Q9Jglw.js";import{S as ve}from"./Search-owRyo6yI.js";import{F as je}from"./FilterList-xvg3S4TU.js";import{C as H}from"./Chat-D0MVNgLz.js";import{E as be}from"./EmojiEmotions-CfLgfpS3.js";import{A as ye}from"./Add-BcIEwuim.js";import{L as Ie}from"./ListItem-5nso4Yx1.js";import{L as Se}from"./ListItemAvatar-DMt-4q_z.js";var x="#4284d0",we="#3874c2",E="#FCE4EC",Ce="#FFF0F5",Re=function(){var V=re();ie();var Y=se(),l=oe(Y.breakpoints.down("md")),I=V.state||null,J=localStorage.getItem("user")||"{}",u=JSON.parse(J),p=(u==null?void 0:u.providerId)||(u==null?void 0:u._id),[K,Q]=c.useState([]),[i,F]=c.useState(I),[b,A]=c.useState(""),[S,g]=c.useState([]),[X,w]=c.useState(!0),[Z,D]=c.useState(!1),[L,$]=c.useState(""),[W,B]=c.useState(!!I),N=c.useRef(null),j=c.useRef(new Set),C=function(t){var s;return t?(s=t.userId)!=null&&s.firstName?(t.userId.firstName+" "+(t.userId.lastName||"")).trim():t.fullName||"Customer":"Customer"},z=function(t){if(!t)return"?";var s=t.split(" ");return s.length>=2?(s[0][0]+s[1][0]).toUpperCase():t.substring(0,2).toUpperCase()},q=function(t){return String(t)===String(p)};c.useEffect(function(){if(!p){w(!1);return}var t=async function(){try{w(!0);var s=await U.get("https://api.bookmyevent.ae/api/enquiries/provider/"+p),r=s.data.data||[],o=r.filter(function(n){var k,O;var f=(((k=n.moduleId)==null?void 0:k.moduleType)||"").toLowerCase(),h=(((O=n.moduleId)==null?void 0:O.title)||"").toLowerCase();return f==="boutique"||f==="fashion"||f==="clothing"||h.includes("boutique")||h.includes("fashion")||h.includes("dress")||h.includes("gown")||h.includes("clothing")});Q(o),!I&&o.length>0&&F(o[0])}catch(n){console.error("Failed to fetch enquiries:",n)}finally{w(!1)}};t()},[p]),c.useEffect(function(){if(i!=null&&i._id){var t=async function(){var r;try{D(!0);var s=await U.get("https://api.bookmyevent.ae/api/enquiries/"+i._id+"/messages");g(((r=s.data)==null?void 0:r.data)||[])}catch(o){console.error("Failed to fetch messages:",o),g([])}finally{D(!1)}};t()}},[i==null?void 0:i._id]),c.useEffect(function(){if(!(!(i!=null&&i._id)||!p)){m.connected||m.connect(),m.emit("join_enquiry",{enquiryId:i._id,vendorId:p});var t=function(r){if(!(r.enquiryId&&r.enquiryId!==i._id)){var o=r._id||r.senderId+"-"+r.timestamp;if(j.current.has(o)||j.current.has(r.timestamp)){j.current.delete(o),j.current.delete(r.timestamp),g(function(n){return n.map(function(f){return f.timestamp===r.timestamp&&String(f.senderId)===String(r.senderId)?{...r,_id:r._id,time:r.time||new Date(r.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}:f})});return}g(function(n){var f=n.some(function(h){return h._id===r._id||h.timestamp&&h.timestamp===r.timestamp&&h.senderId===r.senderId});return f?n:[...n,{...r,time:r.time||new Date(r.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}]})}},s=function(r){g(function(o){return o.filter(function(n){return n._id!==r.messageId})})};return m.on("receive_message",t),m.on("message_deleted",s),function(){m.off("receive_message",t),m.off("message_deleted",s)}}},[i==null?void 0:i._id,p]),c.useEffect(function(){var t;(t=N.current)==null||t.scrollIntoView({behavior:"smooth"})},[S]);var R=function(){var o;if(!(!b.trim()||!(i!=null&&i._id))){var t=b;A("");var s=new Date().toISOString(),r={enquiryId:i._id,senderId:p,receiverId:((o=i.userId)==null?void 0:o._id)||i.userId,senderName:(u==null?void 0:u.businessName)||(u==null?void 0:u.name)||"Vendor",senderRole:"vendor",text:t,message:t,timestamp:s};j.current.add(s),g(function(n){return[...n,{...r,_id:"optimistic-"+Date.now(),time:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}]}),m.emit("send_message",r)}},ee=function(t){!m.connected||!(i!=null&&i._id)||window.confirm("Unsend this message?")&&m.emit("delete_message",{messageId:t,enquiryId:i._id})},te=function(t){F(t),g([]),l&&B(!0)},T=K.filter(function(t){var s=L.toLowerCase();return C(t).toLowerCase().includes(s)||(t.email||"").toLowerCase().includes(s)}),M=i?C(i):"";return e.jsxs(a,{sx:{height:"calc(100vh - 100px)",display:"flex",bgcolor:"white",borderRadius:{xs:"0px",md:"16px"},overflow:"hidden",boxShadow:"0 4px 20px rgba(0,0,0,0.08)",border:"1px solid #E0E4EC",m:{xs:0,md:2}},children:[(!l||!W)&&e.jsxs(a,{sx:{width:{xs:"100%",md:340},minWidth:{md:340},height:"100%",borderRight:"1px solid #E0E4EC",display:"flex",flexDirection:"column",bgcolor:"white"},children:[e.jsxs(a,{sx:{p:2,borderBottom:"1px solid #f0f0f0"},children:[e.jsxs(y,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:1.5},children:[e.jsx(d,{variant:"h5",fontWeight:800,sx:{color:x},children:"Chats"}),e.jsx(v,{size:"small",sx:{bgcolor:E},children:e.jsx(je,{fontSize:"small",sx:{color:x}})})]}),e.jsxs(_,{sx:{p:"2px 8px",display:"flex",alignItems:"center",bgcolor:"#F1F5F9",borderRadius:"12px",boxShadow:"none"},children:[e.jsx(ve,{sx:{color:"#64748B",ml:1}}),e.jsx(ne,{sx:{ml:1,flex:1,p:.8,fontWeight:500,fontSize:"0.9rem"},placeholder:"Search customers...",value:L,onChange:function(t){$(t.target.value)}})]})]}),e.jsx(a,{sx:{flexGrow:1,overflowY:"auto"},children:X?e.jsx(a,{display:"flex",justifyContent:"center",py:4,children:e.jsx(G,{size:28,sx:{color:x}})}):T.length===0?e.jsx(a,{textAlign:"center",py:4,color:"text.secondary",children:e.jsx(d,{variant:"body2",children:"No enquiries found"})}):e.jsx(ae,{sx:{py:0},children:T.map(function(t){var f;var s=C(t),r=z(s),o=(i==null?void 0:i._id)===t._id,n=t.createdAt?new Date(t.createdAt).toLocaleDateString([],{month:"short",day:"numeric"}):"";return e.jsx(Ie,{disablePadding:!0,children:e.jsxs(le,{selected:o,onClick:function(){te(t)},sx:{py:1.8,px:2,borderLeft:o?"4px solid "+x:"4px solid transparent","&.Mui-selected":{bgcolor:Ce},"&:hover":{bgcolor:"#FFF5F8"}},children:[e.jsx(Se,{children:e.jsx(ce,{overlap:"circular",anchorOrigin:{vertical:"bottom",horizontal:"right"},variant:"dot",color:"success",sx:{"& .MuiBadge-badge":{border:"2px solid white"}},children:e.jsx(P,{sx:{bgcolor:E,color:x,fontWeight:700,fontSize:"0.85rem"},children:r})})}),e.jsx(de,{primary:e.jsxs(y,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(d,{variant:"subtitle2",fontWeight:700,noWrap:!0,sx:{maxWidth:150},children:s}),e.jsx(d,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.7rem"},children:n})]}),secondary:e.jsx(d,{variant:"body2",noWrap:!0,sx:{maxWidth:"200px",color:"#64748B",fontSize:"0.8rem"},children:((f=t.moduleId)==null?void 0:f.title)||t.email||"Boutique Enquiry"})})]})},t._id)})})})]}),(!l||W)&&e.jsx(a,{sx:{flexGrow:1,display:"flex",flexDirection:"column",bgcolor:"#F8FAFC",height:"100%"},children:i?e.jsxs(xe.Fragment,{children:[e.jsx(a,{sx:{p:l?1.5:2,bgcolor:"white",borderBottom:"1px solid #E0E4EC",display:"flex",alignItems:"center"},children:e.jsxs(y,{direction:"row",spacing:2,alignItems:"center",children:[l&&e.jsx(v,{onClick:function(){B(!1)},children:e.jsx(ue,{})}),e.jsx(P,{sx:{width:l?40:48,height:l?40:48,bgcolor:x,fontWeight:800,fontSize:l?"0.9rem":"1.1rem"},children:z(M)}),e.jsxs(a,{children:[e.jsx(d,{variant:l?"subtitle1":"h6",fontWeight:800,sx:{lineHeight:1.2},children:M}),e.jsxs(y,{direction:l?"column":"row",spacing:l?0:1.5,alignItems:l?"flex-start":"center",children:[i.email&&e.jsx(d,{variant:"caption",sx:{color:x,fontWeight:700},children:i.email}),!l&&i.contact&&e.jsx(a,{sx:{width:4,height:4,borderRadius:"50%",bgcolor:"#CBD5E1"}}),i.contact&&e.jsx(d,{variant:"caption",sx:{color:"#64748B",fontWeight:600},children:i.contact})]})]})]})}),e.jsxs(a,{sx:{flexGrow:1,overflowY:"auto",p:l?2:3,display:"flex",flexDirection:"column",gap:2},children:[Z?e.jsx(a,{display:"flex",justifyContent:"center",py:4,children:e.jsx(G,{sx:{color:x}})}):S.length===0?e.jsxs(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",opacity:.3},children:[e.jsx(H,{sx:{fontSize:60,color:x,mb:1}}),e.jsx(d,{variant:"h6",fontWeight:600,children:"No messages yet"}),e.jsx(d,{variant:"body2",color:"text.secondary",children:"Start the conversation!"})]}):S.map(function(t,s){var r=q(t.senderId),o=String(t._id).startsWith("optimistic-");return e.jsxs(a,{sx:{alignSelf:r?"flex-end":"flex-start",maxWidth:{xs:"85%",md:"65%"},display:"flex",flexDirection:"column",alignItems:r?"flex-end":"flex-start"},children:[e.jsxs(_,{elevation:0,sx:{p:1.5,px:2,borderRadius:r?"16px 16px 4px 16px":"16px 16px 16px 4px",bgcolor:r?x:"white",color:r?"white":"#1A1A2E",boxShadow:r?"0 4px 12px rgba(216,27,96,0.3)":"0 2px 8px rgba(0,0,0,0.06)",border:r?"none":"1px solid #eef0f4",position:"relative","&:hover .delete-msg":{opacity:1}},children:[e.jsx(d,{variant:"body2",sx:{fontWeight:500,lineHeight:1.5,color:r?"#ffffff !important":"#1A1A2E"},children:t.text||t.message}),r&&!o&&e.jsx(v,{className:"delete-msg",size:"small",onClick:function(){ee(t._id)},sx:{position:"absolute",top:-10,right:-10,bgcolor:"#ff4d4d",color:"#fff",p:.2,opacity:0,transition:"opacity 0.2s","&:hover":{bgcolor:"#cc0000"}},children:e.jsx(fe,{sx:{fontSize:14}})})]}),e.jsx(d,{variant:"caption",sx:{mt:.3,px:1,color:"#94A3B8",fontWeight:600,fontSize:"0.65rem"},children:o?e.jsx("span",{style:{fontStyle:"italic",opacity:.7},children:"sending..."}):e.jsxs("span",{children:[t.time," ",r&&e.jsx(ge,{sx:{fontSize:12,ml:.5,verticalAlign:"middle",color:x}})]})})]},t._id||s)}),e.jsx("div",{ref:N})]}),e.jsx(a,{sx:{p:l?1.5:2,bgcolor:"white",borderTop:"1px solid #E0E4EC"},children:e.jsxs(_,{component:"form",elevation:0,onSubmit:function(t){t.preventDefault(),R()},sx:{p:"4px 8px",display:"flex",alignItems:"center",borderRadius:"16px",bgcolor:"#F8FAFC",border:"1px solid #E2E8F0"},children:[e.jsx(v,{sx:{color:"#64748B"},children:e.jsx(ye,{})}),e.jsx(he,{fullWidth:!0,placeholder:"Type a message...",variant:"standard",value:b,onChange:function(t){A(t.target.value)},InputProps:{disableUnderline:!0},sx:{ml:1,flex:1,"& .MuiInputBase-input":{fontWeight:500}}}),e.jsx(v,{sx:{color:"#64748B"},children:e.jsx(be,{})}),e.jsx(me,{sx:{height:28,mx:1},orientation:"vertical"}),e.jsx(v,{onClick:R,disabled:!b.trim(),sx:{p:1.2,color:"white",bgcolor:x,"&:hover":{bgcolor:we},"&.Mui-disabled":{bgcolor:E,color:"white"}},children:e.jsx(pe,{sx:{fontSize:20}})})]})})]}):e.jsxs(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",opacity:.4},children:[e.jsx(H,{sx:{fontSize:80,color:x,mb:2}}),e.jsx(d,{variant:"h5",fontWeight:700,color:"text.secondary",children:"Select a conversation"}),e.jsx(d,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Choose a customer from the list to start chatting"})]})})]})};export{Re as default};
