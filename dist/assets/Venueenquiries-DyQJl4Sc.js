import{al as re,w as Q,r as n,j as e,B as r,x as X,a8 as Z,S as ee,b as S,am as oe,q as ae,T as c,t as te,s as se,aj as V,V as le,ap as ce,a9 as de,aa as xe,ab as ue,G as R,p as $,M as H,P as he,ag as fe,av as me,ad as je,g as K,h as U}from"./index-Cy0Ohgea.js";import{C as Y}from"./Chat-9idq_5uH.js";import{C as pe}from"./Close-Df0zJraP.js";import{E as ge}from"./Event-CFkfn7TY.js";import{C as ye}from"./Category-CvS0yzSW.js";import{A as Ce}from"./AccessTime-C7NaZXLX.js";import{s as f,S as be}from"./socket-AfkAunyK.js";import{C as ve}from"./ChatBubbleOutline-Efd8v7Hv.js";import{T as Se}from"./TableContainer-L5T0PzqR.js";import{T as we,a as N,b as a,c as Ie}from"./TableRow-CSr_XNGY.js";import{T as De}from"./TableHead-BCTiuLvE.js";const Ee=()=>{var D,q;const A=re(),m=Q(),i=(D=A.state)==null?void 0:D.enquiry,[j,y]=n.useState(""),[g,C]=n.useState([]),[k,w]=n.useState(!0),b=n.useRef(null),l=JSON.parse(localStorage.getItem("user"))||{},p=(l==null?void 0:l.providerId)||(l==null?void 0:l._id);n.useEffect(()=>{i!=null&&i._id||m("/venue/enquiries")},[i==null?void 0:i._id,m]),n.useEffect(()=>{if(!(!(i!=null&&i._id)||!p))return f.connected||f.connect(),f.emit("join_enquiry",{enquiryId:i._id,vendorId:p}),f.on("message_history",t=>{C(t||[]),w(!1)}),f.on("receive_message",t=>{C(x=>x.some(u=>u._id&&u._id===t._id||u.timestamp===t.timestamp&&u.senderId===t.senderId)?x:[...x,t])}),()=>{f.off("message_history"),f.off("receive_message")}},[i==null?void 0:i._id,p]),n.useEffect(()=>{var t;(t=b.current)==null||t.scrollIntoView({behavior:"smooth"})},[g]);const I=()=>{var E;if(!j.trim()||!(i!=null&&i._id))return;const t=j;y("");const x=((E=i.userId)==null?void 0:E._id)||i.userId,h=l==null?void 0:l._id,u={enquiryId:i._id,senderId:h,receiverId:x,senderName:l.businessName||l.name||"Vendor",senderRole:"vendor",text:t,timestamp:new Date().toISOString(),time:new Date().toLocaleTimeString()};console.log("ðŸ“¤ Sending message from Vendor:",u),C(T=>[...T,{...u,message:t,_id:"temp-"+Date.now()}]),f&&f.connected&&f.emit("send_message",u)},d=t=>{const x=String((t==null?void 0:t._id)||t),h=String((p==null?void 0:p._id)||p);return x===h};return i!=null&&i._id?e.jsx(r,{sx:{width:"100%",height:"100vh",display:"flex",flexDirection:"column"},children:e.jsxs(Z,{elevation:0,sx:{width:"100%",height:"100%",display:"flex",flexDirection:"column",borderRadius:0,overflow:"hidden"},children:[e.jsx(r,{sx:{px:2,py:1.5,bgcolor:"#075E54",color:"#fff"},children:e.jsxs(ee,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(S,{onClick:()=>m("/venue/enquiries"),sx:{color:"#fff"},size:"small",children:e.jsx(oe,{})}),e.jsx(ae,{sx:{bgcolor:"#25D366"},children:((q=i.fullName)==null?void 0:q.charAt(0))||"C"}),e.jsxs(r,{flex:1,children:[e.jsx(c,{fontWeight:600,children:i.fullName||"Customer"}),e.jsx(c,{variant:"caption",sx:{opacity:.8},children:"Venue Enquiry"})]})]})}),e.jsxs(r,{sx:{flex:1,overflowY:"auto",bgcolor:"#ECE5DD",p:2,display:"flex",flexDirection:"column"},children:[k?e.jsx(r,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:e.jsx(te,{})}):g.length===0?e.jsx(r,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:e.jsx(c,{color:"text.secondary",children:"No messages yet. Start the conversation!"})}):g.map((t,x)=>{const h=d(t.senderId);return e.jsx(r,{display:"flex",justifyContent:h?"flex-end":"flex-start",mb:1,children:e.jsxs(r,{sx:{px:2,py:1.2,maxWidth:"75%",borderRadius:"18px",bgcolor:h?"#DCF8C6":"#fff",boxShadow:"0 1px 2px rgba(0,0,0,0.15)"},children:[e.jsx(c,{variant:"body2",sx:{wordBreak:"break-word"},children:t.text||t.message}),e.jsx(c,{variant:"caption",sx:{display:"block",textAlign:"right",opacity:.6,mt:.5,fontSize:"0.7rem"},children:t.time||new Date(t.timestamp||t.createdAt).toLocaleTimeString()})]})},t._id||x)}),e.jsx("div",{ref:b})]}),e.jsxs(r,{sx:{p:1.5,bgcolor:"#f7f7f7",borderTop:"1px solid #ddd",display:"flex",gap:1,alignItems:"center"},children:[e.jsx(ve,{sx:{color:"#888"}}),e.jsx(se,{fullWidth:!0,size:"small",placeholder:"Type a message...",value:j,onChange:t=>y(t.target.value),onKeyDown:t=>t.key==="Enter"&&I(),sx:{bgcolor:"#fff",borderRadius:"20px","& .MuiOutlinedInput-root":{borderRadius:"20px"}}}),e.jsx(S,{onClick:I,disabled:!j.trim(),sx:{bgcolor:j.trim()?"#25D366":"#ccc",color:"#fff","&:hover":{bgcolor:j.trim()?"#1ebd5a":"#ccc"}},children:e.jsx(be,{})})]})]})}):e.jsx(r,{p:4,children:e.jsx(X,{severity:"warning",children:"No enquiry selected. Redirecting..."})})},We=()=>{var W,M;const A=Q(),[m,i]=n.useState(""),[j,y]=n.useState([]),[g,C]=n.useState(!0),[k,w]=n.useState(null),[b,l]=n.useState(null),[p,I]=n.useState(!1),[d,D]=n.useState(null),[q,t]=n.useState(!1),[x,h]=n.useState(!1),[u,E]=n.useState(null);n.useEffect(()=>{const s=localStorage.getItem("user");if(s){const o=JSON.parse(s);l(o.providerId||o._id)}},[]),n.useEffect(()=>{(async()=>{if(!b){w("Provider ID not found"),C(!1);return}try{const z=((await U.get(`https://api.bookmyevent.ae/api/enquiries/provider/${b}`)).data.data||[]).filter(B=>{var O,P,F,G,J;return((P=(O=B.moduleId)==null?void 0:O.moduleType)==null?void 0:P.toLowerCase())==="venue"||((G=(F=B.moduleId)==null?void 0:F.title)==null?void 0:G.toLowerCase().includes("venue"))||((J=B.moduleId)==null?void 0:J._id)==="68e5ea9f27ca1c19b2d3924a"});y(z),w(null)}catch{w("Failed to fetch enquiries"),y([])}finally{C(!1)}})()},[b]);const T=j.filter(s=>{var o;return(s.fullName||"").toLowerCase().includes(m.toLowerCase())||(s.email||"").toLowerCase().includes(m.toLowerCase())||(s.contact||"").includes(m)||(((o=s.moduleId)==null?void 0:o.title)||"").toLowerCase().includes(m.toLowerCase())}),ie=s=>{D(s),I(!0)},L=()=>{I(!1),D(null)},ne=async s=>{if(window.confirm("Are you sure you want to delete this enquiry?")){t(!0);try{await U.delete(`https://api.bookmyevent.ae/api/enquiries/${s}`),y(j.filter(o=>o._id!==s)),alert("Enquiry deleted successfully")}catch(o){alert("Failed to delete enquiry"),console.error(o)}finally{t(!1)}}},v=({icon:s,label:o,value:_})=>e.jsxs(r,{display:"flex",alignItems:"center",gap:2,py:1.5,sx:{borderBottom:"1px solid",borderColor:"divider","&:last-child":{borderBottom:"none"}},children:[e.jsx(r,{sx:{width:40,height:40,borderRadius:"50%",bgcolor:"primary.light",color:"primary.main",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:s}),e.jsxs(r,{children:[e.jsx(c,{variant:"caption",color:"text.secondary",children:o}),e.jsx(c,{fontWeight:500,children:_||"N/A"})]})]});return e.jsxs(r,{p:2,children:[e.jsx(c,{variant:"h4",gutterBottom:!0,children:"Venue Enquiries"}),k&&e.jsx(X,{severity:"error",sx:{mb:2},children:k}),e.jsxs(Z,{sx:{mt:2},children:[e.jsx(r,{p:2,children:e.jsx(se,{label:"Search venue enquiries",size:"small",value:m,onChange:s=>i(s.target.value),fullWidth:!0})}),e.jsx(Se,{children:e.jsxs(we,{children:[e.jsx(De,{children:e.jsxs(N,{children:[e.jsx(a,{children:"#"}),e.jsx(a,{children:"Customer"}),e.jsx(a,{children:"Venue"}),e.jsx(a,{children:"Contact"}),e.jsx(a,{children:"Date"}),e.jsx(a,{align:"center",children:"Actions"})]})}),e.jsxs(Ie,{children:[g&&e.jsx(N,{children:e.jsx(a,{colSpan:6,align:"center",children:e.jsx(te,{size:28})})}),!g&&T.map((s,o)=>{var _,z;return e.jsxs(N,{hover:!0,children:[e.jsx(a,{children:o+1}),e.jsxs(a,{children:[e.jsx(c,{fontWeight:600,children:s.fullName}),e.jsx(c,{variant:"caption",color:"text.secondary",children:s.email})]}),e.jsx(a,{children:((_=s.packageDetails)==null?void 0:_.venueName)||((z=s.moduleId)==null?void 0:z.title)}),e.jsx(a,{children:s.contact}),e.jsx(a,{children:new Date(s.bookingDate).toLocaleDateString()}),e.jsx(a,{align:"center",children:e.jsxs(ee,{direction:"row",spacing:1,justifyContent:"center",children:[e.jsx(V,{title:"Chat",children:e.jsx(S,{size:"small",color:"primary",onClick:()=>{A("/venue/enquirychat",{state:{enquiry:s}})},children:e.jsx(Y,{fontSize:"small"})})}),e.jsx(V,{title:"View",children:e.jsx(S,{size:"small",color:"info",onClick:()=>ie(s),children:e.jsx(le,{fontSize:"small"})})}),e.jsx(V,{title:"Delete",children:e.jsx(S,{size:"small",color:"error",onClick:()=>ne(s._id),disabled:q,children:e.jsx(ce,{fontSize:"small"})})})]})})]},s._id)}),!g&&T.length===0&&e.jsx(N,{children:e.jsx(a,{colSpan:6,align:"center",children:"No venue enquiries found"})})]})]})})]}),e.jsxs(de,{open:p,onClose:L,maxWidth:"md",fullWidth:!0,children:[e.jsx(xe,{sx:{bgcolor:"primary.main",color:"white"},children:e.jsxs(r,{display:"flex",justifyContent:"space-between",children:[e.jsx(c,{fontWeight:600,children:"Venue Enquiry Details"}),e.jsx(S,{onClick:L,sx:{color:"white"},children:e.jsx(pe,{})})]})}),e.jsx(ue,{children:d&&e.jsxs(R,{container:!0,spacing:3,mt:1,children:[e.jsx(R,{item:!0,xs:12,md:6,children:e.jsx($,{variant:"outlined",children:e.jsxs(H,{children:[e.jsx(c,{fontWeight:600,mb:2,children:"Customer Information"}),e.jsx(v,{icon:e.jsx(he,{fontSize:"small"}),label:"Full Name",value:d.fullName}),e.jsx(v,{icon:e.jsx(fe,{fontSize:"small"}),label:"Email",value:d.email}),e.jsx(v,{icon:e.jsx(me,{fontSize:"small"}),label:"Contact",value:d.contact})]})})}),e.jsx(R,{item:!0,xs:12,md:6,children:e.jsx($,{variant:"outlined",children:e.jsxs(H,{children:[e.jsx(c,{fontWeight:600,mb:2,children:"Booking Information"}),e.jsx(v,{icon:e.jsx(ye,{fontSize:"small"}),label:"Venue",value:((W=d.packageDetails)==null?void 0:W.venueName)||((M=d.moduleId)==null?void 0:M.title)}),e.jsx(v,{icon:e.jsx(ge,{fontSize:"small"}),label:"Booking Date",value:new Date(d.bookingDate).toLocaleDateString()}),e.jsx(v,{icon:e.jsx(Ce,{fontSize:"small"}),label:"Created At",value:new Date(d.createdAt).toLocaleString()})]})})})]})}),e.jsxs(je,{children:[e.jsx(K,{onClick:L,variant:"outlined",children:"Close"}),e.jsx(K,{variant:"contained",startIcon:e.jsx(Y,{}),onClick:()=>{L(),E(d),h(!0)},children:"Open Chat"})]})]}),u&&e.jsx(Ee,{open:x,onClose:()=>{h(!1),E(null)},enquiry:u})]})};export{We as default};
