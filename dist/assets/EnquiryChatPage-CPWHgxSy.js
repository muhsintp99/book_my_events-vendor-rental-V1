import{a9 as re,a as ie,u as oe,l as ne,r as c,j as e,B as a,S as v,T as d,d as g,am as C,av as ae,v as G,$ as le,aw as ce,ax as de,p as V,a0 as xe,R as me,aa as he,af as fe,t as pe,D as ue,i as H}from"./index-CYOhujfk.js";import{s as f,S as ge}from"./socket-1gxIgjxL.js";import{D as be}from"./DoneAll-D8RL9Xp_.js";import{S as je}from"./Search-Cy2wkmMw.js";import{F as ve}from"./FilterList-CvwIyGky.js";import{C as Y}from"./Chat-CF5hv-fW.js";import{E as ye}from"./EmojiEmotions-Bv6kZ5cO.js";import{A as Se}from"./Add-B94w46PM.js";import{L as Ie}from"./ListItem-C2TvZKFO.js";import{L as we}from"./ListItemAvatar-DqwYW7vW.js";const Me=()=>{var N;const J=re();ie();const K=oe(),l=ne(K.breakpoints.down("md")),y=((N=J.state)==null?void 0:N.enquiry)||null,[Q,$]=c.useState([]),[r,_]=c.useState(y),[j,D]=c.useState(""),[S,u]=c.useState([]),[X,I]=c.useState(!0),[Z,E]=c.useState(!1),[L,q]=c.useState(""),[A,W]=c.useState(!!y),B=c.useRef(null),b=c.useRef(new Set),x=JSON.parse(localStorage.getItem("user"))||{},p=(x==null?void 0:x.providerId)||(x==null?void 0:x._id),w=t=>{var i;return t?(i=t.userId)!=null&&i.firstName?(t.userId.firstName+" "+(t.userId.lastName||"")).trim():t.fullName||"Customer":"Customer"},z=t=>{if(!t)return"?";var i=t.split(" ");return i.length>=2?(i[0][0]+i[1][0]).toUpperCase():t.substring(0,2).toUpperCase()},ee=t=>String(t)===String(p);c.useEffect(()=>{if(!p){I(!1);return}var t=async()=>{try{I(!0);var i=await H.get("https://api.bookmyevent.ae/api/enquiries/provider/"+p),s=i.data.data||[],o=s.filter(n=>{var k,T,O,P,U;var m=(T=(k=n.moduleId)==null?void 0:k.moduleType)==null?void 0:T.toLowerCase(),h=(P=(O=n.moduleId)==null?void 0:O.title)==null?void 0:P.toLowerCase();return m==="venue"||h&&h.includes("venue")||((U=n.moduleId)==null?void 0:U._id)==="68e5ea9f27ca1c19b2d3924a"});$(o),!y&&o.length>0&&_(o[0])}catch(n){console.error("Failed to fetch enquiries:",n)}finally{I(!1)}};t()},[p]),c.useEffect(()=>{if(r!=null&&r._id){var t=async()=>{var s;try{E(!0);var i=await H.get("https://api.bookmyevent.ae/api/enquiries/"+r._id+"/messages");u(((s=i.data)==null?void 0:s.data)||[])}catch(o){console.error("Failed to fetch messages:",o),u([])}finally{E(!1)}};t()}},[r==null?void 0:r._id]),c.useEffect(()=>{if(!(!(r!=null&&r._id)||!p)){f.connected||f.connect(),f.emit("join_enquiry",{enquiryId:r._id,vendorId:p});var t=s=>{if(!(s.enquiryId&&s.enquiryId!==r._id)){var o=s._id||s.senderId+"-"+s.timestamp;if(b.current.has(o)||b.current.has(s.timestamp)){b.current.delete(o),b.current.delete(s.timestamp),u(n=>n.map(m=>m.timestamp===s.timestamp&&String(m.senderId)===String(s.senderId)?{...s,_id:s._id,time:s.time||new Date(s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}:m));return}u(n=>{var m=n.some(h=>h._id===s._id||h.timestamp&&h.timestamp===s.timestamp&&h.senderId===s.senderId);return m?n:[...n,{...s,time:s.time||new Date(s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}]})}},i=s=>{u(o=>o.filter(n=>n._id!==s.messageId))};return f.on("receive_message",t),f.on("message_deleted",i),()=>{f.off("receive_message",t),f.off("message_deleted",i)}}},[r==null?void 0:r._id,p]),c.useEffect(()=>{var t;(t=B.current)==null||t.scrollIntoView({behavior:"smooth"})},[S]);var F=()=>{var o;if(!(!j.trim()||!(r!=null&&r._id))){var t=j;D("");var i=new Date().toISOString(),s={enquiryId:r._id,senderId:p,receiverId:((o=r.userId)==null?void 0:o._id)||r.userId,senderName:(x==null?void 0:x.businessName)||(x==null?void 0:x.name)||"Vendor",senderRole:"vendor",text:t,message:t,timestamp:i};b.current.add(i),u(n=>[...n,{...s,_id:"optimistic-"+Date.now(),time:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}]),f.emit("send_message",s)}},te=t=>{!f.connected||!(r!=null&&r._id)||window.confirm("Unsend this message?")&&f.emit("delete_message",{messageId:t,enquiryId:r._id})},se=t=>{_(t),u([]),l&&W(!0)},M=Q.filter(t=>{var i=w(t).toLowerCase(),s=(t.email||"").toLowerCase(),o=L.toLowerCase();return i.includes(o)||s.includes(o)}),R=r?w(r):"";return e.jsxs(a,{sx:{height:"calc(100vh - 100px)",display:"flex",bgcolor:"white",borderRadius:{xs:"0px",md:"16px"},overflow:"hidden",boxShadow:"0 4px 20px rgba(0,0,0,0.08)",border:"1px solid #E0E4EC",m:{xs:0,md:2}},children:[(!l||!A)&&e.jsxs(a,{sx:{width:{xs:"100%",md:340},minWidth:{md:340},height:"100%",borderRight:"1px solid #E0E4EC",display:"flex",flexDirection:"column",bgcolor:"white"},children:[e.jsxs(a,{sx:{p:2,borderBottom:"1px solid #f0f0f0"},children:[e.jsxs(v,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:1.5},children:[e.jsx(d,{variant:"h5",fontWeight:800,sx:{color:"#1abc9c"},children:"Chats"}),e.jsx(g,{size:"small",sx:{bgcolor:"#e8f8f5"},children:e.jsx(ve,{fontSize:"small",sx:{color:"#1abc9c"}})})]}),e.jsxs(C,{sx:{p:"2px 8px",display:"flex",alignItems:"center",bgcolor:"#F1F5F9",borderRadius:"12px",boxShadow:"none"},children:[e.jsx(je,{sx:{color:"#64748B",ml:1}}),e.jsx(ae,{sx:{ml:1,flex:1,p:.8,fontWeight:500,fontSize:"0.9rem"},placeholder:"Search customers...",value:L,onChange:t=>q(t.target.value)})]})]}),e.jsx(a,{sx:{flexGrow:1,overflowY:"auto"},children:X?e.jsx(a,{display:"flex",justifyContent:"center",py:4,children:e.jsx(G,{size:28,sx:{color:"#1abc9c"}})}):M.length===0?e.jsx(a,{textAlign:"center",py:4,color:"text.secondary",children:e.jsx(d,{variant:"body2",children:"No enquiries found"})}):e.jsx(le,{sx:{py:0},children:M.map(t=>{var m,h;var i=w(t),s=z(i),o=(r==null?void 0:r._id)===t._id,n=t.createdAt?new Date(t.createdAt).toLocaleDateString([],{month:"short",day:"numeric"}):"";return e.jsx(Ie,{disablePadding:!0,children:e.jsxs(ce,{selected:o,onClick:()=>se(t),sx:{py:1.8,px:2,borderLeft:o?"4px solid #1abc9c":"4px solid transparent","&.Mui-selected":{bgcolor:"#e8f8f5"},"&:hover":{bgcolor:"#f0fdf9"}},children:[e.jsx(we,{children:e.jsx(de,{overlap:"circular",anchorOrigin:{vertical:"bottom",horizontal:"right"},variant:"dot",color:"success",sx:{"& .MuiBadge-badge":{border:"2px solid white"}},children:e.jsx(V,{sx:{bgcolor:"#d1f2eb",color:"#1abc9c",fontWeight:700,fontSize:"0.85rem"},children:s})})}),e.jsx(xe,{primary:e.jsxs(v,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(d,{variant:"subtitle2",fontWeight:700,noWrap:!0,sx:{maxWidth:150},children:i}),e.jsx(d,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.7rem"},children:n})]}),secondary:e.jsx(d,{variant:"body2",noWrap:!0,sx:{maxWidth:"200px",color:"#64748B",fontSize:"0.8rem"},children:((m=t.packageDetails)==null?void 0:m.venueName)||((h=t.moduleId)==null?void 0:h.title)||t.email||"Venue Enquiry"})})]})},t._id)})})})]}),(!l||A)&&e.jsx(a,{sx:{flexGrow:1,display:"flex",flexDirection:"column",bgcolor:"#F8FAFC",height:"100%"},children:r?e.jsxs(me.Fragment,{children:[e.jsx(a,{sx:{p:l?1.5:2,bgcolor:"white",borderBottom:"1px solid #E0E4EC",display:"flex",alignItems:"center",justifyContent:"space-between"},children:e.jsxs(v,{direction:"row",spacing:2,alignItems:"center",children:[l&&e.jsx(g,{onClick:()=>W(!1),children:e.jsx(he,{})}),e.jsx(V,{sx:{width:l?40:48,height:l?40:48,bgcolor:"#1abc9c",fontWeight:800,fontSize:l?"0.9rem":"1.1rem"},children:z(R)}),e.jsxs(a,{children:[e.jsx(d,{variant:l?"subtitle1":"h6",fontWeight:800,sx:{lineHeight:1.2},children:R}),e.jsxs(v,{direction:l?"column":"row",spacing:l?0:1.5,alignItems:l?"flex-start":"center",children:[r.email&&e.jsx(d,{variant:"caption",sx:{color:"#1abc9c",fontWeight:700},children:r.email}),!l&&r.contact&&e.jsx(a,{sx:{width:4,height:4,borderRadius:"50%",bgcolor:"#CBD5E1"}}),r.contact&&e.jsx(d,{variant:"caption",sx:{color:"#64748B",fontWeight:600},children:r.contact})]})]})]})}),e.jsxs(a,{sx:{flexGrow:1,overflowY:"auto",p:l?2:3,display:"flex",flexDirection:"column",gap:2},children:[Z?e.jsx(a,{display:"flex",justifyContent:"center",py:4,children:e.jsx(G,{sx:{color:"#1abc9c"}})}):S.length===0?e.jsxs(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",opacity:.3},children:[e.jsx(Y,{sx:{fontSize:60,color:"#1abc9c",mb:1}}),e.jsx(d,{variant:"h6",fontWeight:600,children:"No messages yet"}),e.jsx(d,{variant:"body2",color:"text.secondary",children:"Start the conversation!"})]}):S.map((t,i)=>{var s=ee(t.senderId),o=String(t._id).startsWith("optimistic-");return e.jsxs(a,{sx:{alignSelf:s?"flex-end":"flex-start",maxWidth:{xs:"85%",md:"65%"},display:"flex",flexDirection:"column",alignItems:s?"flex-end":"flex-start"},children:[e.jsxs(C,{elevation:0,sx:{p:1.5,px:2,borderRadius:s?"16px 16px 4px 16px":"16px 16px 16px 4px",bgcolor:s?"#1abc9c":"white",color:s?"white":"#1A1A2E",boxShadow:s?"0 4px 12px rgba(26,188,156,0.3)":"0 2px 8px rgba(0,0,0,0.06)",border:s?"none":"1px solid #eef0f4",position:"relative","&:hover .delete-msg":{opacity:1}},children:[e.jsx(d,{variant:"body2",sx:{fontWeight:500,lineHeight:1.5,color:s?"#ffffff !important":"#1A1A2E"},children:t.text||t.message}),s&&!o&&e.jsx(g,{className:"delete-msg",size:"small",onClick:()=>te(t._id),sx:{position:"absolute",top:-10,right:-10,bgcolor:"#ff4d4d",color:"#fff",p:.2,opacity:0,transition:"opacity 0.2s","&:hover":{bgcolor:"#cc0000"}},children:e.jsx(fe,{sx:{fontSize:14}})})]}),e.jsx(d,{variant:"caption",sx:{mt:.3,px:1,color:"#94A3B8",fontWeight:600,fontSize:"0.65rem"},children:o?e.jsx("span",{style:{fontStyle:"italic",opacity:.7},children:"sending..."}):e.jsxs("span",{children:[t.time," ",s&&e.jsx(be,{sx:{fontSize:12,ml:.5,verticalAlign:"middle",color:"#1abc9c"}})]})})]},t._id||i)}),e.jsx("div",{ref:B})]}),e.jsx(a,{sx:{p:l?1.5:2,bgcolor:"white",borderTop:"1px solid #E0E4EC"},children:e.jsxs(C,{component:"form",elevation:0,onSubmit:t=>{t.preventDefault(),F()},sx:{p:"4px 8px",display:"flex",alignItems:"center",borderRadius:"16px",bgcolor:"#F8FAFC",border:"1px solid #E2E8F0"},children:[e.jsx(g,{sx:{color:"#64748B"},children:e.jsx(Se,{})}),e.jsx(pe,{fullWidth:!0,placeholder:"Type a message...",variant:"standard",value:j,onChange:t=>D(t.target.value),InputProps:{disableUnderline:!0},sx:{ml:1,flex:1,"& .MuiInputBase-input":{fontWeight:500}}}),e.jsx(g,{sx:{color:"#64748B"},children:e.jsx(ye,{})}),e.jsx(ue,{sx:{height:28,mx:1},orientation:"vertical"}),e.jsx(g,{onClick:F,disabled:!j.trim(),sx:{p:1.2,color:"white",bgcolor:"#1abc9c","&:hover":{bgcolor:"#16a085"},"&.Mui-disabled":{bgcolor:"#b2dfdb",color:"white"}},children:e.jsx(ge,{sx:{fontSize:20}})})]})})]}):e.jsxs(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",opacity:.4},children:[e.jsx(Y,{sx:{fontSize:80,color:"#1abc9c",mb:2}}),e.jsx(d,{variant:"h5",fontWeight:700,color:"text.secondary",children:"Select a conversation"}),e.jsx(d,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Choose a customer from the list to start chatting"})]})})]})};export{Me as default};
