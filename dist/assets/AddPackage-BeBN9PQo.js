import{g as Ce,d as we,m as Se,r as u,j as e,B as n,o as A,p as ie,T as s,w as ke,s as D,b as _,a1 as Ie,N as ae,e as ne,a as m,z as Ae,a6 as ue,y as oe,Z as Ee}from"./index-CWJg_lwt.js";import{A as Be}from"./Autocomplete-CK5HcTem.js";import{A as Te}from"./Add-GGc6Xt8k.js";import{C as se}from"./Close-D09zOr9j.js";const le=ue(n)(({theme:o})=>({border:"2px dashed #e0e0e0",borderRadius:o.shape.borderRadius,padding:o.spacing(3),textAlign:"center",backgroundColor:o.palette.grey[50],cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"150px","&:hover":{borderColor:"#E15B65"},'& input[type="file"]':{display:"none"}})),de=ue(n)({position:"relative",display:"inline-block"}),E="https://api.bookmyevent.ae",Fe=()=>{try{const o=localStorage.getItem("user");if(!o)return null;const g=JSON.parse(o);return(g==null?void 0:g._id)||null}catch(o){return console.error("getProviderId parse error",o),null}},ce=()=>localStorage.getItem("token")||sessionStorage.getItem("token")||null,O=o=>{if(!o)return"/placeholder.jpg";let g=String(o||"").toLowerCase().replace(/^uploads/i,"/uploads");return g.startsWith("/")||(g="/"+g),`${E}${g}`},Pe=(o=[])=>o.map(g=>({value:g._id,label:g.title||g.name||"Untitled"})),De=()=>{var ee,te;const o=Ce(),g=we(),z=Se(),[ge,H]=u.useState("form"),[h,U]=u.useState({packageTitle:"",subtitle:"",description:"",startingPrice:"",advanceBookingAmount:""}),[G,v]=u.useState([{id:Date.now(),heading:"",includes:""}]),[B,j]=u.useState(null),[T,N]=u.useState([]),[pe,L]=u.useState({}),[C,F]=u.useState(null),[P,W]=u.useState([]),[J,f]=u.useState(!1),[q,w]=u.useState(""),[V,S]=u.useState("success"),[i,X]=u.useState(null),[Z,K]=u.useState(!0);u.useEffect(()=>{let t=!1;return(async()=>{try{K(!0);const a=ce(),l=localStorage.getItem("moduleId");l||console.warn("No moduleId in localStorage");const c={Accept:"application/json"};a&&(c.Authorization=`Bearer ${a}`);const x=l?`${E}/api/categories/modules/${l}`:`${E}/api/categories`,d=await fetch(x,{headers:c});if(!d.ok)throw new Error(`Failed to load categories: ${d.status}`);const y=await d.json();if(!t)if(y.success&&Array.isArray(y.data)){const k=Pe(y.data);N(k);const $={};(y.data||[]).forEach(I=>{$[I._id]=I.title||I.name||""}),L($)}else N([]),L({})}catch(a){console.error("fetchCategories error",a),N([]),L({})}finally{t||K(!1)}})(),()=>{t=!0}},[]),u.useEffect(()=>{var t;if((t=z.state)!=null&&t.editPackage){const r=z.state.editPackage;X(r),Q(r)}},[z.state]),u.useEffect(()=>{var t,r;if(i&&T.length>0&&!B&&((t=i.categories)==null?void 0:t.length)>0){const a=((r=i.categories[0])==null?void 0:r._id)||i.categories[0],l=T.find(c=>c.value===a);j(l||{value:a,label:pe[a]||"Uncategorized"})}},[T,i]);const Q=t=>{var c;const r=t.price||0,a=(r*.1).toFixed(2);U({packageTitle:t.title||"",subtitle:t.subtitle||"",description:t.description||"",startingPrice:r.toString()||"",advanceBookingAmount:a.toString()||""}),v((t.includes||[]).map((x,d)=>({id:Date.now()+d,heading:x.title||"",includes:(x.items||[]).join(", ")})));const l=(c=t.categories)==null?void 0:c[0];j(l?{value:l._id||l,label:l.title||l.name||""}:null),F(null),W([])},M=t=>{const{name:r,value:a}=t.target;U(l=>{const c={...l,[r]:a};if(r==="startingPrice"){const x=parseFloat(a)||0;c.advanceBookingAmount=(x*.1).toFixed(2)}return c})},Y=(t,r,a)=>{v(l=>l.map(c=>c.id===t?{...c,[r]:a}:c))},he=()=>v(t=>[...t,{id:Date.now(),heading:"",includes:""}]),xe=t=>v(r=>r.filter(a=>a.id!==t)),me=t=>{var a;const r=(a=t.target.files)==null?void 0:a[0];r&&F(r)},be=t=>{const r=Array.from(t.target.files||[]);r.length&&W(a=>[...a,...r])},je=t=>W(r=>r.filter((a,l)=>l!==t)),fe=()=>F(null),R=(t,r)=>{r!=="clickaway"&&f(!1)},ye=()=>{i&&Q(i),H("form")},ve=async t=>{var re;t.preventDefault();const r=ce();if(!r){w("Authentication required"),S("error"),f(!0);return}const a=Fe();if(!a){console.error("Provider ID missing. user:",localStorage.getItem("user")),w("Provider ID missing. Please login as vendor."),S("error"),f(!0);return}const l=localStorage.getItem("moduleId")||((re=i==null?void 0:i.module)==null?void 0:re._id)||(i==null?void 0:i.module)||"",c=G.filter(p=>p.includes&&p.includes.trim()).map(p=>({title:p.heading.trim()||"Section",items:p.includes.split(",").map(b=>b.trim()).filter(Boolean)})),x=parseFloat(h.startingPrice)||0,d=new FormData;d.append("providerId",a),l&&d.append("module",l),d.append("title",h.packageTitle||"Custom Package"),d.append("subtitle",h.subtitle||""),d.append("description",h.description||""),d.append("cateringType","custom"),d.append("includes",JSON.stringify(c)),B?d.append("categories",JSON.stringify([B.value])):d.append("categories",JSON.stringify([])),d.append("price",String(x));const y=(x*.1).toFixed(2);d.append("advanceBookingAmount",String(y)),C&&d.append("thumbnail",C),P.forEach(p=>d.append("images",p));const k=!!(i!=null&&i._id),$=k?`${E}/api/catering/${i._id}`:`${E}/api/catering`,I=k?"PUT":"POST";try{const p=await fetch($,{method:I,body:d,headers:{Authorization:`Bearer ${r}`}}),b=await p.json().catch(()=>({success:!1,message:"Invalid JSON response"}));if(!p.ok){console.error("Save failed",b),w(b.error||b.message||"Failed to save"),S("error"),f(!0);return}U({packageTitle:"",subtitle:"",description:"",startingPrice:"",advanceBookingAmount:""}),v([{id:Date.now(),heading:"",includes:""}]),j(null),F(null),W([]),X(b.data||null),H("preview"),w(b.message||`Catering ${k?"updated":"created"} successfully`),S("success"),f(!0)}catch(p){console.error("submit error",p),w("Error saving catering: "+(p.message||p)),S("error"),f(!0)}};return ge==="preview"&&i?e.jsx(n,{sx:{p:3,backgroundColor:o.palette.grey[100],minHeight:"100vh",width:"100%"},children:e.jsxs(n,{sx:{width:"100%",margin:"auto",backgroundColor:"white",borderRadius:o.shape.borderRadius,boxShadow:o.shadows[1],p:3,overflowX:"hidden"},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2,mb:3},children:[e.jsx(A,{onClick:()=>g(-1),color:"primary",children:e.jsx(ie,{})}),e.jsx(s,{variant:"h5",children:"Package Preview"})]}),e.jsxs(n,{sx:{position:"relative",mb:3},children:[e.jsx("img",{src:O(i.thumbnail),alt:i.title,style:{width:"100%",height:200,objectFit:"cover",borderRadius:8},onError:t=>{t.target.onerror=null,t.target.src="/placeholder.jpg"}}),e.jsxs(n,{sx:{position:"absolute",bottom:0,left:0,right:0,background:"linear-gradient(transparent, rgba(0,0,0,0.7))",color:"white",p:2},children:[e.jsx(s,{variant:"h6",children:i.title||"Untitled Package"}),e.jsx(s,{variant:"body2",children:i.subtitle||""})]})]}),e.jsx(s,{variant:"body1",sx:{mb:3,textAlign:"justify"},children:i.description||"No description available."}),i.categories&&i.categories.length>0&&e.jsxs(n,{sx:{mb:3},children:[e.jsx(s,{variant:"h6",sx:{mb:1},children:"Category"}),e.jsx(ke,{label:((ee=i.categories[0])==null?void 0:ee.title)||i.categories[0]||"Uncategorized",variant:"outlined",color:"primary"})]}),e.jsx(s,{variant:"h6",sx:{mb:2},children:"Includes"}),(i.includes||[]).map((t,r)=>{var a;return e.jsxs(n,{sx:{mb:2},children:[e.jsx(s,{variant:"subtitle1",sx:{mb:1,fontWeight:"medium"},children:t.title||"Untitled Section"}),e.jsx(D,{component:"ul",spacing:.5,sx:{pl:2,mb:0},children:((a=t.items)==null?void 0:a.map((l,c)=>e.jsx(s,{variant:"body2",component:"li",children:l},c)))||e.jsx(s,{variant:"body2",color:"text.secondary",children:"No items"})})]},r)}),e.jsxs(n,{sx:{textAlign:"center",mb:3},children:[e.jsx(s,{variant:"h6",sx:{mb:.5},children:"Starting Price"}),e.jsxs(s,{variant:"h4",color:"primary",children:["₹",i.price||0," Per Head"]}),i.price>0&&e.jsxs(s,{variant:"body2",color:"text.secondary",children:["Advance Booking (10% Fixed): ₹",(i.price*.1).toFixed(2)]})]}),e.jsxs(n,{sx:{mb:3},children:[e.jsx(s,{variant:"subtitle1",sx:{mb:1},children:"Gallery"}),e.jsx(D,{direction:"row",spacing:2,sx:{flexWrap:"wrap",justifyContent:"center"},children:(i.images||[]).slice(0,6).map((t,r)=>e.jsx(n,{sx:{position:"relative"},children:e.jsx("img",{src:O(t),alt:`Gallery ${r+1}`,style:{width:150,height:150,objectFit:"cover",borderRadius:8},onError:a=>{a.target.onerror=null,a.target.src="/placeholder.jpg"}})},r))})]}),e.jsx(n,{sx:{display:"flex",gap:2,justifyContent:"center"},children:e.jsx(_,{variant:"outlined",startIcon:e.jsx(Ie,{}),onClick:ye,sx:{color:"#E15B65",borderColor:"#E15B65"},children:"Edit Menu"})}),e.jsx(ae,{open:J,autoHideDuration:6e3,onClose:R,anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(ne,{onClose:R,severity:V,sx:{width:"100%"},children:q})})]})}):e.jsx(n,{sx:{p:3,backgroundColor:o.palette.grey[100],minHeight:"100vh",width:"100%"},children:e.jsxs(n,{sx:{width:"100%",margin:"auto",backgroundColor:"white",borderRadius:o.shape.borderRadius,boxShadow:o.shadows[1],p:3,overflowX:"hidden"},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2,mb:3},children:[i&&e.jsx(A,{onClick:()=>g(-1),color:"primary",children:e.jsx(ie,{})}),e.jsx(s,{variant:"h5",children:i?"Edit Menu":"Add New Menu"})]}),e.jsxs(n,{component:"form",onSubmit:ve,children:[e.jsx(m,{fullWidth:!0,label:"Package Title",name:"packageTitle",value:h.packageTitle,onChange:M,placeholder:"Type package title",sx:{mb:2},variant:"outlined"}),e.jsx(m,{fullWidth:!0,label:"Subtitle",name:"subtitle",value:h.subtitle,onChange:M,placeholder:"Type subtitle",sx:{mb:2},variant:"outlined"}),e.jsx(m,{fullWidth:!0,label:"Description",name:"description",value:h.description,onChange:M,placeholder:"Type description",multiline:!0,rows:3,sx:{mb:2},variant:"outlined"}),e.jsx(Be,{fullWidth:!0,options:T,getOptionLabel:t=>t.label,isOptionEqualToValue:(t,r)=>t.value===(r==null?void 0:r.value),value:B,onChange:(t,r)=>j(r),renderInput:t=>e.jsx(m,{...t,label:"Category",placeholder:Z?"Loading categories...":"Select a category",sx:{mb:2},variant:"outlined",disabled:Z})}),e.jsxs(n,{sx:{mb:3},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(s,{variant:"subtitle1",children:"Menu List"}),e.jsx(_,{variant:"contained",size:"small",onClick:he,startIcon:e.jsx(Te,{}),sx:{backgroundColor:"#E15B65",color:"white"},children:"Add"})]}),G.map(t=>e.jsxs(n,{sx:{border:`1px solid ${o.palette.grey[300]}`,borderRadius:1,p:2,mb:2},children:[e.jsx(m,{fullWidth:!0,label:"Add heading here",value:t.heading,onChange:r=>Y(t.id,"heading",r.target.value),sx:{mb:2},variant:"outlined"}),e.jsxs(n,{sx:{display:"flex",gap:1,alignItems:"flex-end"},children:[e.jsx(m,{fullWidth:!0,label:"Includes",value:t.includes,onChange:r=>Y(t.id,"includes",r.target.value),multiline:!0,rows:3,sx:{flex:1},variant:"outlined",placeholder:"Enter items separated by commas"}),e.jsx(A,{onClick:()=>xe(t.id),color:"error",sx:{alignSelf:"flex-end"},children:e.jsx(Ae,{})})]})]},t.id))]}),e.jsxs(n,{sx:{display:"flex",gap:3,mb:3},children:[e.jsxs(n,{sx:{flex:1},children:[e.jsx(s,{variant:"subtitle2",gutterBottom:!0,children:"Thumbnail Image"}),e.jsxs(le,{onClick:()=>document.getElementById("thumbnail-upload").click(),children:[C?e.jsxs(n,{sx:{textAlign:"center"},children:[e.jsxs(de,{children:[e.jsx("img",{src:URL.createObjectURL(C),alt:"Thumbnail preview",style:{maxWidth:"100%",maxHeight:100,objectFit:"contain",marginBottom:o.spacing(1)}}),e.jsx(A,{onClick:fe,size:"small",sx:{position:"absolute",top:-8,right:-8,backgroundColor:"white",color:"error",boxShadow:o.shadows[2]},children:e.jsx(se,{fontSize:"small"})})]}),e.jsx(s,{variant:"body2",color:"text.secondary",children:C.name})]}):i!=null&&i.thumbnail?e.jsxs(n,{sx:{textAlign:"center"},children:[e.jsx("img",{src:O(i.thumbnail),alt:"Current thumbnail",style:{maxWidth:"100%",maxHeight:100,objectFit:"contain",marginBottom:o.spacing(1)},onError:t=>{t.target.onerror=null,t.target.src="/placeholder.jpg"}}),e.jsx(s,{variant:"body2",color:"text.secondary",children:"Current thumbnail. Click to replace."})]}):e.jsxs(n,{children:[e.jsx(oe,{sx:{fontSize:40,color:o.palette.grey[400],mb:1}}),e.jsx(s,{variant:"body2",color:"#E15B65",sx:{mb:.5,fontWeight:"medium"},children:"Click to upload"}),e.jsx(s,{variant:"body2",color:"text.secondary",children:"Or drag and drop"})]}),e.jsx("input",{type:"file",id:"thumbnail-upload",hidden:!0,accept:"image/jpeg,image/png,image/jpg",onChange:me})]})]}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(s,{variant:"subtitle2",gutterBottom:!0,children:"Gallery Images"}),e.jsxs(le,{onClick:()=>document.getElementById("gallery-upload").click(),children:[P.length>0?e.jsxs(n,{sx:{textAlign:"center"},children:[e.jsx(D,{direction:"row",flexWrap:"wrap",spacing:1,sx:{justifyContent:"center",mb:1},children:P.map((t,r)=>e.jsxs(de,{children:[e.jsx("img",{src:URL.createObjectURL(t),alt:`Gallery preview ${r+1}`,style:{width:100,height:100,objectFit:"cover",borderRadius:4}}),e.jsx(A,{onClick:()=>je(r),size:"small",sx:{position:"absolute",top:-8,right:-8,backgroundColor:"white",color:"error",boxShadow:o.shadows[2]},children:e.jsx(se,{fontSize:"small"})})]},r))}),e.jsxs(s,{variant:"body2",color:"text.secondary",children:[P.length," image(s) selected"]})]}):e.jsxs(n,{children:[e.jsx(oe,{sx:{fontSize:40,color:o.palette.grey[400],mb:1}}),e.jsx(s,{variant:"body2",color:"#E15B65",sx:{mb:.5,fontWeight:"medium"},children:"Click to upload"}),e.jsx(s,{variant:"body2",color:"text.secondary",children:"Or drag and drop"})]}),e.jsx("input",{type:"file",id:"gallery-upload",hidden:!0,accept:"image/jpeg,image/png,image/jpg",multiple:!0,onChange:be})]}),((te=i==null?void 0:i.images)==null?void 0:te.length)>0&&e.jsxs(n,{sx:{mt:2},children:[e.jsx(s,{variant:"subtitle2",gutterBottom:!0,color:"text.secondary",children:"Existing Images"}),e.jsx(D,{direction:"row",flexWrap:"wrap",spacing:1,children:i.images.map((t,r)=>e.jsx(n,{sx:{position:"relative"},children:e.jsx("img",{src:O(t),alt:`Existing gallery ${r+1}`,style:{width:100,height:100,objectFit:"cover",borderRadius:4},onError:a=>{a.target.onerror=null,a.target.src="/placeholder.jpg"}})},r))})]})]})]}),e.jsxs(n,{sx:{mb:3,display:"flex",gap:2},children:[e.jsx(m,{fullWidth:!0,label:"₹ Price (Starting From)",name:"startingPrice",value:h.startingPrice,onChange:M,type:"number",inputProps:{min:0},InputProps:{endAdornment:e.jsx(Ee,{position:"end",children:e.jsx(s,{variant:"body2",color:"text.secondary",children:"Per Head"})})},variant:"outlined"}),e.jsx(m,{fullWidth:!0,label:"Advance Percentage (%)",value:"10",disabled:!0,variant:"outlined",helperText:`Fixed 10% advance: ₹${h.advanceBookingAmount||0}`})]}),e.jsx(_,{type:"submit",variant:"contained",fullWidth:!0,sx:{backgroundColor:"#E15B65",color:"white",py:1.5},children:i?"Update Menu":"Create Menu"})]}),e.jsx(ae,{open:J,autoHideDuration:6e3,onClose:R,anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(ne,{onClose:R,severity:V,sx:{width:"100%"},children:q})})]})})};export{De as default};
