import{aj as ae,w as Q,r as n,j as e,B as a,x as X,a8 as Z,S as ee,b as I,ak as re,q as oe,T as c,t as se,s as te,h as R,at as A,V as le,an as ce,a9 as de,aa as xe,ab as ue,G as B,p as J,M as K,P as he,ag as fe,av as me,ad as je,g as U}from"./index-CLRvsGTH.js";import{C as Y}from"./Chat-DX4S9Oj1.js";import{C as pe}from"./Close-CVhvqm57.js";import{E as ge}from"./Event-Ce4I1W_u.js";import{C as ve}from"./Category-Sa9cezw6.js";import{A as ye}from"./AccessTime-CWg-vzGv.js";import{S as Ce}from"./Send-CBVPU9Rv.js";import{C as be}from"./ChatBubbleOutline-CNT1vnsY.js";import{s as b}from"./socket-BpXQx-Y7.js";import{T as Ie}from"./TableContainer-jqoFZr5I.js";import{T as Se,a as T,b as l,c as we}from"./TableRow-CxxGRe1L.js";import{T as Ee}from"./TableHead-ChkVmriI.js";const De=()=>{var d,w;const z=ae(),h=Q(),s=(d=z.state)==null?void 0:d.enquiry,[f,p]=n.useState(""),[m,g]=n.useState([]),[k,v]=n.useState(!0),y=n.useRef(null),o=JSON.parse(localStorage.getItem("user"))||{},j=(o==null?void 0:o.providerId)||(o==null?void 0:o._id);n.useEffect(()=>{s!=null&&s._id||h("/venue/enquiries")},[s==null?void 0:s._id,h]),n.useEffect(()=>{if(!(s!=null&&s._id))return;(async()=>{var u;try{v(!0);const x=await R.get(`https://api.bookmyevent.ae/api/enquiries/${s._id}/messages`);g(((u=x.data)==null?void 0:u.data)||[])}catch(x){console.error("Failed to fetch messages:",x),g([])}finally{v(!1)}})()},[s==null?void 0:s._id]),n.useEffect(()=>{if(!(s!=null&&s._id)||!j)return;b.connected||b.connect(),b.emit("join_enquiry",{enquiryId:s._id,vendorId:j});const i=u=>{g(x=>x.some(E=>E.timestamp===u.timestamp&&E.senderId===u.senderId)?x:[...x,u])};return b.on("receive_message",i),()=>{b.off("receive_message",i)}},[s==null?void 0:s._id,j]),n.useEffect(()=>{var i;(i=y.current)==null||i.scrollIntoView({behavior:"smooth"})},[m]);const S=()=>{if(!f.trim()||!(s!=null&&s._id))return;const i={enquiryId:s._id,senderId:j,senderName:(o==null?void 0:o.businessName)||(o==null?void 0:o.name)||"Vendor",senderRole:"vendor",text:f,timestamp:new Date().toISOString()};b.emit("send_message",i),p("")};return s!=null&&s._id?e.jsx(a,{sx:{minHeight:"100vh",bgcolor:"#f0f2f5",display:"flex",justifyContent:"center",alignItems:"center",p:3},children:e.jsxs(Z,{elevation:8,sx:{width:"100%",maxWidth:450,height:"80vh",display:"flex",flexDirection:"column",borderRadius:3,overflow:"hidden"},children:[e.jsx(a,{sx:{px:2,py:1.5,bgcolor:"#075E54",color:"#fff"},children:e.jsxs(ee,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(I,{onClick:()=>h("/venue/enquiries"),sx:{color:"#fff"},size:"small",children:e.jsx(re,{})}),e.jsx(oe,{sx:{bgcolor:"#25D366"},children:((w=s.fullName)==null?void 0:w.charAt(0))||"C"}),e.jsxs(a,{flex:1,children:[e.jsx(c,{fontWeight:600,children:s.fullName||"Customer"}),e.jsx(c,{variant:"caption",sx:{opacity:.8},children:"Venue Enquiry"})]})]})}),e.jsxs(a,{sx:{flex:1,overflowY:"auto",bgcolor:"#ECE5DD",p:2,display:"flex",flexDirection:"column"},children:[k?e.jsx(a,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:e.jsx(se,{})}):m.length===0?e.jsx(a,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:e.jsx(c,{color:"text.secondary",children:"No messages yet. Start the conversation!"})}):m.map((i,u)=>{const x=i.senderId===j;return e.jsx(a,{display:"flex",justifyContent:x?"flex-end":"flex-start",mb:1,children:e.jsxs(a,{sx:{px:2,py:1.2,maxWidth:"75%",borderRadius:"18px",bgcolor:x?"#DCF8C6":"#fff",boxShadow:"0 1px 2px rgba(0,0,0,0.15)"},children:[e.jsx(c,{variant:"body2",sx:{wordBreak:"break-word"},children:i.text}),e.jsx(c,{variant:"caption",sx:{display:"block",textAlign:"right",opacity:.6,mt:.5,fontSize:"0.7rem"},children:new Date(i.timestamp).toLocaleTimeString()})]})},u)}),e.jsx("div",{ref:y})]}),e.jsxs(a,{sx:{p:1.5,bgcolor:"#f7f7f7",borderTop:"1px solid #ddd",display:"flex",gap:1,alignItems:"center"},children:[e.jsx(be,{sx:{color:"#888"}}),e.jsx(te,{fullWidth:!0,size:"small",placeholder:"Type a message...",value:f,onChange:i=>p(i.target.value),onKeyDown:i=>i.key==="Enter"&&S(),sx:{bgcolor:"#fff",borderRadius:"20px","& .MuiOutlinedInput-root":{borderRadius:"20px"}}}),e.jsx(I,{onClick:S,disabled:!f.trim(),sx:{bgcolor:f.trim()?"#25D366":"#ccc",color:"#fff","&:hover":{bgcolor:f.trim()?"#1ebd5a":"#ccc"}},children:e.jsx(Ce,{})})]})]})}):e.jsx(a,{p:4,children:e.jsx(X,{severity:"warning",children:"No enquiry selected. Redirecting..."})})},Me=()=>{var M,O;const z=Q(),[h,s]=n.useState(""),[f,p]=n.useState([]),[m,g]=n.useState(!0),[k,v]=n.useState(null),[y,o]=n.useState(null),[j,S]=n.useState(!1),[d,w]=n.useState(null),[i,u]=n.useState(!1),[x,L]=n.useState(!1),[E,V]=n.useState(null);n.useEffect(()=>{const t=localStorage.getItem("user");if(t){const r=JSON.parse(t);o(r.providerId||r._id)}},[]),n.useEffect(()=>{(async()=>{if(!y){v("Provider ID not found"),g(!1);return}try{const _=((await R.get(`https://api.bookmyevent.ae/api/enquiries/provider/${y}`)).data.data||[]).filter(N=>{var P,F,$,G,H;return((F=(P=N.moduleId)==null?void 0:P.moduleType)==null?void 0:F.toLowerCase())==="venue"||((G=($=N.moduleId)==null?void 0:$.title)==null?void 0:G.toLowerCase().includes("venue"))||((H=N.moduleId)==null?void 0:H._id)==="68e5ea9f27ca1c19b2d3924a"});p(_),v(null)}catch{v("Failed to fetch enquiries"),p([])}finally{g(!1)}})()},[y]);const W=f.filter(t=>{var r;return(t.fullName||"").toLowerCase().includes(h.toLowerCase())||(t.email||"").toLowerCase().includes(h.toLowerCase())||(t.contact||"").includes(h)||(((r=t.moduleId)==null?void 0:r.title)||"").toLowerCase().includes(h.toLowerCase())}),ne=t=>{w(t),S(!0)},q=()=>{S(!1),w(null)},ie=async t=>{if(window.confirm("Are you sure you want to delete this enquiry?")){u(!0);try{await R.delete(`https://api.bookmyevent.ae/api/enquiries/${t}`),p(f.filter(r=>r._id!==t)),alert("Enquiry deleted successfully")}catch(r){alert("Failed to delete enquiry"),console.error(r)}finally{u(!1)}}},C=({icon:t,label:r,value:D})=>e.jsxs(a,{display:"flex",alignItems:"center",gap:2,py:1.5,sx:{borderBottom:"1px solid",borderColor:"divider","&:last-child":{borderBottom:"none"}},children:[e.jsx(a,{sx:{width:40,height:40,borderRadius:"50%",bgcolor:"primary.light",color:"primary.main",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:t}),e.jsxs(a,{children:[e.jsx(c,{variant:"caption",color:"text.secondary",children:r}),e.jsx(c,{fontWeight:500,children:D||"N/A"})]})]});return e.jsxs(a,{p:2,children:[e.jsx(c,{variant:"h4",gutterBottom:!0,children:"Venue Enquiries"}),k&&e.jsx(X,{severity:"error",sx:{mb:2},children:k}),e.jsxs(Z,{sx:{mt:2},children:[e.jsx(a,{p:2,children:e.jsx(te,{label:"Search venue enquiries",size:"small",value:h,onChange:t=>s(t.target.value),fullWidth:!0})}),e.jsx(Ie,{children:e.jsxs(Se,{children:[e.jsx(Ee,{children:e.jsxs(T,{children:[e.jsx(l,{children:"#"}),e.jsx(l,{children:"Customer"}),e.jsx(l,{children:"Venue"}),e.jsx(l,{children:"Contact"}),e.jsx(l,{children:"Date"}),e.jsx(l,{align:"center",children:"Actions"})]})}),e.jsxs(we,{children:[m&&e.jsx(T,{children:e.jsx(l,{colSpan:6,align:"center",children:e.jsx(se,{size:28})})}),!m&&W.map((t,r)=>{var D,_;return e.jsxs(T,{hover:!0,children:[e.jsx(l,{children:r+1}),e.jsxs(l,{children:[e.jsx(c,{fontWeight:600,children:t.fullName}),e.jsx(c,{variant:"caption",color:"text.secondary",children:t.email})]}),e.jsx(l,{children:((D=t.packageDetails)==null?void 0:D.venueName)||((_=t.moduleId)==null?void 0:_.title)}),e.jsx(l,{children:t.contact}),e.jsx(l,{children:new Date(t.bookingDate).toLocaleDateString()}),e.jsx(l,{align:"center",children:e.jsxs(ee,{direction:"row",spacing:1,justifyContent:"center",children:[e.jsx(A,{title:"Chat",children:e.jsx(I,{size:"small",color:"primary",onClick:()=>{z("/venue/enquirychat",{state:{enquiry:t}})},children:e.jsx(Y,{fontSize:"small"})})}),e.jsx(A,{title:"View",children:e.jsx(I,{size:"small",color:"info",onClick:()=>ne(t),children:e.jsx(le,{fontSize:"small"})})}),e.jsx(A,{title:"Delete",children:e.jsx(I,{size:"small",color:"error",onClick:()=>ie(t._id),disabled:i,children:e.jsx(ce,{fontSize:"small"})})})]})})]},t._id)}),!m&&W.length===0&&e.jsx(T,{children:e.jsx(l,{colSpan:6,align:"center",children:"No venue enquiries found"})})]})]})})]}),e.jsxs(de,{open:j,onClose:q,maxWidth:"md",fullWidth:!0,children:[e.jsx(xe,{sx:{bgcolor:"primary.main",color:"white"},children:e.jsxs(a,{display:"flex",justifyContent:"space-between",children:[e.jsx(c,{fontWeight:600,children:"Venue Enquiry Details"}),e.jsx(I,{onClick:q,sx:{color:"white"},children:e.jsx(pe,{})})]})}),e.jsx(ue,{children:d&&e.jsxs(B,{container:!0,spacing:3,mt:1,children:[e.jsx(B,{item:!0,xs:12,md:6,children:e.jsx(J,{variant:"outlined",children:e.jsxs(K,{children:[e.jsx(c,{fontWeight:600,mb:2,children:"Customer Information"}),e.jsx(C,{icon:e.jsx(he,{fontSize:"small"}),label:"Full Name",value:d.fullName}),e.jsx(C,{icon:e.jsx(fe,{fontSize:"small"}),label:"Email",value:d.email}),e.jsx(C,{icon:e.jsx(me,{fontSize:"small"}),label:"Contact",value:d.contact})]})})}),e.jsx(B,{item:!0,xs:12,md:6,children:e.jsx(J,{variant:"outlined",children:e.jsxs(K,{children:[e.jsx(c,{fontWeight:600,mb:2,children:"Booking Information"}),e.jsx(C,{icon:e.jsx(ve,{fontSize:"small"}),label:"Venue",value:((M=d.packageDetails)==null?void 0:M.venueName)||((O=d.moduleId)==null?void 0:O.title)}),e.jsx(C,{icon:e.jsx(ge,{fontSize:"small"}),label:"Booking Date",value:new Date(d.bookingDate).toLocaleDateString()}),e.jsx(C,{icon:e.jsx(ye,{fontSize:"small"}),label:"Created At",value:new Date(d.createdAt).toLocaleString()})]})})})]})}),e.jsxs(je,{children:[e.jsx(U,{onClick:q,variant:"outlined",children:"Close"}),e.jsx(U,{variant:"contained",startIcon:e.jsx(Y,{}),onClick:()=>{q(),V(d),L(!0)},children:"Open Chat"})]})]}),E&&e.jsx(De,{open:x,onClose:()=>{L(!1),V(null)},enquiry:E})]})};export{Me as default};
