import{r as l,j as e,a9 as P,aa as F,S as L,q as H,B as j,T as m,b as _,ab as J,t as V,ap as Y,ad as G,s as Q}from"./index-DaiSIVFY.js";import{C as U}from"./ChatBubbleOutline-CC5Q4fJ6.js";import{D as X}from"./DoneAll-B_eSXIVJ.js";import{C as Z}from"./Close-nUc7dfNC.js";import{S as $}from"./Send-BHaMEiE8.js";import{s}from"./socket-BpXQx-Y7.js";const ae=({open:I,onClose:D,enquiry:o})=>{var R,k;const[f,S]=l.useState(""),[b,g]=l.useState([]),[N,C]=l.useState(!1),[h,v]=l.useState(!1),E=l.useRef(null),d=JSON.parse(localStorage.getItem("user"))||{},w=d==null?void 0:d._id;l.useEffect(()=>{var t;(t=E.current)==null||t.scrollIntoView({behavior:"smooth"})},[b]),l.useEffect(()=>{var A;if(!I||!(o!=null&&o._id))return;C(!0);const t=o._id,i=d==null?void 0:d._id,r=((A=o.userId)==null?void 0:A._id)||o.userId;s.connected||s.connect();const n=()=>{v(!0),s.emit("join_enquiry",{enquiryId:t,vendorId:i,userId:r})},p=()=>{v(!1)},M=a=>{g(a||[]),C(!1)},T=a=>{g(x=>{const u=x.find(c=>{var z;return((z=c._id)==null?void 0:z.startsWith("temp-"))&&(c.message===a.message||c.text===a.message)&&String(c.senderId)===String(a.senderId)});return u?x.map(c=>c._id===u._id?a:c):[...x,a]})},W=({messageId:a})=>{g(x=>x.filter(u=>u._id!==a))};return s.on("connect",n),s.on("disconnect",p),s.on("message_history",M),s.on("receive_message",T),s.on("message_deleted",W),s.connected&&n(),()=>{s.off("connect",n),s.off("disconnect",p),s.off("message_history",M),s.off("receive_message",T),s.off("message_deleted",W)}},[I,o==null?void 0:o._id]);const y=()=>{var n;if(!f.trim())return;const t="temp-"+Date.now(),i=f,r={enquiryId:o._id,senderId:w,receiverId:((n=o.userId)==null?void 0:n._id)||o.userId,senderRole:"vendor",message:i,timestamp:new Date().toISOString()};g(p=>[...p,{...r,_id:t}]),S(""),s.connected&&s.emit("send_message",r)},B=t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),y())},O=t=>{s.connected&&s.emit("delete_message",{messageId:t,enquiryId:o._id})},K=t=>String(t)===String(w);return o?e.jsxs(P,{open:I,onClose:D,fullWidth:!0,maxWidth:"sm",PaperProps:{sx:{height:"80vh",display:"flex",flexDirection:"column"}},children:[e.jsx(F,{sx:{bgcolor:"#075E54",color:"#fff"},children:e.jsxs(L,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(H,{sx:{bgcolor:"#25D366"},children:((R=o.fullName)==null?void 0:R.charAt(0))||"C"}),e.jsxs(j,{flex:1,children:[e.jsx(m,{fontWeight:600,children:o.fullName}),e.jsxs(m,{variant:"caption",children:[(k=o.moduleId)==null?void 0:k.title,h&&" â€¢ Connected"]})]}),e.jsx(_,{onClick:D,sx:{color:"#fff"},children:e.jsx(Z,{})})]})}),e.jsxs(J,{sx:{flex:1,overflowY:"auto",bgcolor:"#ECE5DD",p:2},children:[N?e.jsx(j,{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",children:e.jsx(V,{})}):b.length===0?e.jsx(m,{textAlign:"center",color:"text.secondary",children:"No messages yet. Start the conversation!"}):b.map(t=>{var n;const i=K(t.senderId),r=(n=t._id)==null?void 0:n.startsWith("temp-");return e.jsx(j,{display:"flex",justifyContent:i?"flex-end":"flex-start",mb:1,children:e.jsxs(j,{sx:{p:1.5,borderRadius:i?"15px 15px 2px 15px":"15px 15px 15px 2px",bgcolor:i?"#DCF8C6":"#fff",position:"relative",maxWidth:"75%",transition:"0.2s ease","&:hover .delete-btn":{opacity:1,transform:"scale(1)"}},children:[e.jsx(m,{variant:"body2",children:t.message||t.text}),i&&!r&&e.jsx(_,{className:"delete-btn",size:"small",onClick:()=>O(t._id),sx:{position:"absolute",top:-8,right:-8,bgcolor:"#ff4d4d",color:"#fff",p:.5,opacity:0,transform:"scale(0.8)",transition:"all 0.2s ease","&:hover":{bgcolor:"#cc0000"}},children:e.jsx(Y,{sx:{fontSize:12}})}),e.jsxs(m,{variant:"caption",sx:{display:"flex",alignItems:"center",justifyContent:"flex-end",gap:.5,mt:.5,fontSize:"0.65rem",color:"text.secondary"},children:[r?"sending...":e.jsx(X,{sx:{fontSize:12,color:"#4caf50"}}),new Date(t.timestamp||t.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})},t._id)}),e.jsx("div",{ref:E})]}),e.jsxs(G,{sx:{p:1.5,bgcolor:"#f7f7f7"},children:[e.jsx(U,{sx:{color:"#888"}}),e.jsx(Q,{fullWidth:!0,size:"small",placeholder:"Type a message...",value:f,onChange:t=>S(t.target.value),onKeyDown:B,multiline:!0,maxRows:3,disabled:!h,sx:{bgcolor:"#fff",borderRadius:"20px","& .MuiOutlinedInput-root":{borderRadius:"20px"}}}),e.jsx(_,{onClick:y,disabled:!f.trim()||!h,sx:{bgcolor:f.trim()&&h?"#25D366":"#ccc",color:"#fff","&:hover":{bgcolor:"#1ebd5a"}},children:e.jsx($,{})})]})]}):null};export{ae as E};
