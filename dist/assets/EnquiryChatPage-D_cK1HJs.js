import{aj as _,w,r as n,j as s,B as i,x as E,a8 as k,S as D,b as I,ak as R,q as N,T as x,t as B,s as M,h as T}from"./index-CLRvsGTH.js";import{S as A}from"./Send-CBVPU9Rv.js";import{C as O}from"./ChatBubbleOutline-CNT1vnsY.js";import{s as l}from"./socket-BpXQx-Y7.js";const V=()=>{var b,v;const C=_(),f=w(),e=(b=C.state)==null?void 0:b.enquiry,[c,g]=n.useState(""),[h,m]=n.useState([]),[S,p]=n.useState(!0),u=n.useRef(null),o=JSON.parse(localStorage.getItem("user"))||{},d=(o==null?void 0:o.providerId)||(o==null?void 0:o._id);n.useEffect(()=>{e!=null&&e._id||f("/venue/enquiries")},[e==null?void 0:e._id,f]),n.useEffect(()=>{if(!(e!=null&&e._id))return;(async()=>{var a;try{p(!0);const r=await T.get(`https://api.bookmyevent.ae/api/enquiries/${e._id}/messages`);m(((a=r.data)==null?void 0:a.data)||[])}catch(r){console.error("Failed to fetch messages:",r),m([])}finally{p(!1)}})()},[e==null?void 0:e._id]),n.useEffect(()=>{if(!(e!=null&&e._id)||!d)return;l.connected||l.connect(),l.emit("join_enquiry",{enquiryId:e._id,vendorId:d});const t=a=>{m(r=>r.some(y=>y.timestamp===a.timestamp&&y.senderId===a.senderId)?r:[...r,a])};return l.on("receive_message",t),()=>{l.off("receive_message",t)}},[e==null?void 0:e._id,d]),n.useEffect(()=>{var t;(t=u.current)==null||t.scrollIntoView({behavior:"smooth"})},[h]);const j=()=>{if(!c.trim()||!(e!=null&&e._id))return;const t={enquiryId:e._id,senderId:d,senderName:(o==null?void 0:o.businessName)||(o==null?void 0:o.name)||"Vendor",senderRole:"vendor",text:c,timestamp:new Date().toISOString()};l.emit("send_message",t),g("")};return e!=null&&e._id?s.jsx(i,{sx:{minHeight:"100vh",bgcolor:"#f0f2f5",display:"flex",justifyContent:"center",alignItems:"center",p:3},children:s.jsxs(k,{elevation:8,sx:{width:"100%",maxWidth:450,height:"80vh",display:"flex",flexDirection:"column",borderRadius:3,overflow:"hidden"},children:[s.jsx(i,{sx:{px:2,py:1.5,bgcolor:"#075E54",color:"#fff"},children:s.jsxs(D,{direction:"row",alignItems:"center",spacing:2,children:[s.jsx(I,{onClick:()=>f("/venue/enquiries"),sx:{color:"#fff"},size:"small",children:s.jsx(R,{})}),s.jsx(N,{sx:{bgcolor:"#25D366"},children:((v=e.fullName)==null?void 0:v.charAt(0))||"C"}),s.jsxs(i,{flex:1,children:[s.jsx(x,{fontWeight:600,children:e.fullName||"Customer"}),s.jsx(x,{variant:"caption",sx:{opacity:.8},children:"Venue Enquiry"})]})]})}),s.jsxs(i,{sx:{flex:1,overflowY:"auto",bgcolor:"#ECE5DD",p:2,display:"flex",flexDirection:"column"},children:[S?s.jsx(i,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:s.jsx(B,{})}):h.length===0?s.jsx(i,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:s.jsx(x,{color:"text.secondary",children:"No messages yet. Start the conversation!"})}):h.map((t,a)=>{const r=t.senderId===d;return s.jsx(i,{display:"flex",justifyContent:r?"flex-end":"flex-start",mb:1,children:s.jsxs(i,{sx:{px:2,py:1.2,maxWidth:"75%",borderRadius:"18px",bgcolor:r?"#DCF8C6":"#fff",boxShadow:"0 1px 2px rgba(0,0,0,0.15)"},children:[s.jsx(x,{variant:"body2",sx:{wordBreak:"break-word"},children:t.text}),s.jsx(x,{variant:"caption",sx:{display:"block",textAlign:"right",opacity:.6,mt:.5,fontSize:"0.7rem"},children:new Date(t.timestamp).toLocaleTimeString()})]})},a)}),s.jsx("div",{ref:u})]}),s.jsxs(i,{sx:{p:1.5,bgcolor:"#f7f7f7",borderTop:"1px solid #ddd",display:"flex",gap:1,alignItems:"center"},children:[s.jsx(O,{sx:{color:"#888"}}),s.jsx(M,{fullWidth:!0,size:"small",placeholder:"Type a message...",value:c,onChange:t=>g(t.target.value),onKeyDown:t=>t.key==="Enter"&&j(),sx:{bgcolor:"#fff",borderRadius:"20px","& .MuiOutlinedInput-root":{borderRadius:"20px"}}}),s.jsx(I,{onClick:j,disabled:!c.trim(),sx:{bgcolor:c.trim()?"#25D366":"#ccc",color:"#fff","&:hover":{bgcolor:c.trim()?"#1ebd5a":"#ccc"}},children:s.jsx(A,{})})]})]})}):s.jsx(i,{p:4,children:s.jsx(E,{severity:"warning",children:"No enquiry selected. Redirecting..."})})};export{V as default};
